<!DOCTYPE html>
<html lang="zh-Hant">
<head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-65GTWZKRV5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-65GTWZKRV5');
</script>
  <meta charset="UTF-8">
  <title>å¨ƒå¨ƒæ©Ÿæ¸…å–®v2.1</title>
  <!-- æ‰‹æ©Ÿå°ºå¯¸é—œéµï¼šviewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <style>
    :root{
      --space: 16px;
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body { font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, Arial, sans-serif; margin: 0; background: #f4f6f8; color:#1f2937; }
    header { position:sticky; top:0; z-index:10; background: #2c3e50; color: white; padding: 14px var(--space); font-size: 18px; }

    /* ç™»éŒ„é  */
    .auth-wrapper {
      display: flex; justify-content: center; align-items: center;
      min-height: calc(100vh - 56px);
      padding: 24px;
      background: linear-gradient(135deg, #3498db, #8e44ad);
    }
    .auth-card {
      background: white; padding: 28px 24px; border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      width: 100%; max-width: 420px; text-align: center;
    }
    .auth-card h2 { margin: 0 0 6px; color: #2c3e50; font-size: 22px; }
    .subtitle { margin: 0 0 14px; color: #6b7280; font-size: 14px; }
    .auth-card input {
      width: 100%; padding: 12px 14px; margin: 10px 0;
      border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px;
    }

    /* æŒ‰éˆ•ï¼ˆæ‰‹æ©Ÿå‹å–„ï¼šé«˜åº¦>=44pxã€å…¨å¯¬ï¼‰ */
    button {
      width: 100%; min-height: 44px; padding: 12px; margin: 8px 0;
      border: none; border-radius: 12px; font-size: 16px;
      cursor: pointer; transition: box-shadow .25s ease, transform .05s ease;
      font-weight: 700;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: scale(.98) }
    .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
    .btn-secondary { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
    .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
    .btn-success { background: linear-gradient(135deg, #f39c12, #d35400); color: white; }
    .btn-small { width: auto; padding: 8px 12px; font-size: 14px; min-height: 36px; }

    .auth-message { margin-top: 8px; font-size: 14px; color: #ef4444; }

    /* ä¸»ä»‹é¢ */
    .app-wrapper { max-width: 1024px; margin: 24px auto; padding: 0 var(--space); }
    .app-header { display: flex; gap:12px; flex-wrap:wrap; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .app-header h2{ font-size: 20px; margin:0 }

    .app-card {
      background: white; padding: 16px; margin-bottom: 16px;
      border-radius: var(--radius); box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    .app-card h3{ margin: 0 0 12px; font-size: 18px; }

    .form-row{ display:grid; grid-template-columns: 1fr; gap:12px; }
    .form-group { text-align: left; }
    .form-group label { display: block; margin-bottom: 6px; color: #374151; font-size: 14px; }
    .form-group input {
      width: 100%; padding: 12px 14px;
      border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px;
    }

    /* åœ°åœ–åœ¨æ‰‹æ©Ÿä»¥è¦–çª—é«˜åº¦é¡¯ç¤ºæ›´å¤§ä¸€äº› */
    #map { width: 100%; height: 50vh; min-height: 280px; border-radius: 12px; }

    /* è¡¨æ ¼ï¼šå¤–å±¤åŠ æ»¾å‹•å®¹å™¨ï¼Œé¿å…å°è¢å¹•æº¢å‡º */
    .table-wrap{ width:100%; overflow-x:auto; -webkit-overflow-scrolling: touch; border-radius:12px; }
    table { width: 100%; border-collapse: collapse; min-width: 640px; }
    th, td { border: 1px solid #e5e7eb; padding: 10px; font-size: 14px; }
    th { background: #f9fafb; text-align: left; }

    /* å¤§è¢å¹•å¾®èª¿ */
    @media (min-width: 640px){
      .form-row{ grid-template-columns: 1fr 1fr; }
      .auth-card{ padding: 32px 28px; }
    }
    @media (min-width: 1024px){
      header{ font-size: 20px; padding: 16px 24px; }
      .app-wrapper{ margin: 32px auto; }
      .app-card{ padding: 20px; margin-bottom: 18px; }
      #map{ height: 420px; }
    }
  </style>
</head>
<body>
  <header>å¨ƒå¨ƒæ©Ÿæ¸…å–®ç®¡ç†</header>

  <!-- ç™»éŒ„å€ -->
  <div class="auth-wrapper" id="authSection">
    <div class="auth-card">
      <h2>ğŸ® å¨ƒå¨ƒæ©Ÿåœ°åœ– App</h2>
      <p class="subtitle">è«‹ç™»å…¥ä»¥ç®¡ç†æ‚¨çš„æ¸…å–®</p>
      <input type="email" id="email" placeholder="é›»å­éƒµä»¶">
      <input type="password" id="password" placeholder="å¯†ç¢¼">
      <button class="btn-primary" onclick="login()">ç™»å…¥</button>
      <button class="btn-secondary" onclick="register()">è¨»å†Šæ–°å¸³è™Ÿ</button>
      <button class="btn-primary" onclick="loginWithGoogle()">ä½¿ç”¨ Google ç™»éŒ„</button>
      <p id="authMessage" class="auth-message"></p>
    </div>
  </div>

  <!-- ä¸»åŠŸèƒ½å€ -->
  <div class="app-wrapper" id="appSection" style="display:none;">
    <div class="app-header">
      <h2 id="welcomeText">æ­¡è¿ï¼</h2>
      <button class="btn-danger btn-small" onclick="logout()">ç™»å‡º</button>
    </div>

    <div class="app-card">
      <h3>â• æ–°å¢åº—å®¶</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="storeName">åº—å</label>
          <input type="text" id="storeName" placeholder="è«‹è¼¸å…¥åº—å">
        </div>
        <div class="form-group">
          <label for="storeAddr">åœ°å€</label>
          <input type="text" id="storeAddr" placeholder="è«‹è¼¸å…¥åœ°å€">
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;">
        <button class="btn-primary" onclick="addRecord()">å„²å­˜</button>
        <button class="btn-success" onclick="exportCSV()">åŒ¯å‡º CSV</button>
      </div>
    </div>

    <div class="app-card">
      <h3>ğŸ“‹ æˆ‘çš„æ¸…å–®</h3>
      <div class="table-wrap">
        <table id="dataTable">
          <thead>
            <tr>
              <th>åº—å</th>
              <th>åœ°å€</th>
              <th>æ™‚é–“</th>
              <th>ç¶“åº¦</th>
              <th>ç·¯åº¦</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="app-card">
      <h3>ğŸ—ºï¸ åœ°åœ–</h3>
      <div id="map"></div>
    </div>

    <div class="app-card">
      <h3>ğŸ“¦ å·²åŒ¯å‡ºæ¸…å–®</h3>
      <div class="table-wrap">
        <table id="exportedTable">
          <thead>
            <tr>
              <th>åº—å</th>
              <th>åœ°å€</th>
              <th>æ™‚é–“</th>
              <th>ç¶“åº¦</th>
              <th>ç·¯åº¦</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
      GoogleAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyB1SOrDItdUUshN2DuijWjdEAbuNXGvY6A",
      authDomain: "clawmachine-68199.firebaseapp.com",
      projectId: "clawmachine-68199",
      storageBucket: "clawmachine-68199.appspot.com",
      messagingSenderId: "416551705279",
      appId: "1:416551705279:web:3ba72ebcc992da5f78440a"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let currentUser = "guest";
    onAuthStateChanged(auth, (user) => {
      if (user && user.email) {
        currentUser = user.email;
        authSection.style.display = "none";
        appSection.style.display = "block";
        welcomeText.innerText = `æ­¡è¿å›ä¾†ï¼Œ${user.email}`;
      } else {
        currentUser = "guest";
        authSection.style.display = "flex";
        appSection.style.display = "none";
      }
      loadFromLocal();
    });

    // ===== ç™»éŒ„ç›¸é—œ =====
    window.register = async () => {
      try { await createUserWithEmailAndPassword(auth, email.value, password.value);
        authMessage.textContent = "âœ… è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥"; }
      catch (e) { authMessage.textContent = "âŒ è¨»å†Šå¤±æ•—ï¼š" + e.code; }
    };
    window.login = async () => {
      try { await signInWithEmailAndPassword(auth, email.value, password.value); }
      catch (e) { authMessage.textContent = "âŒ ç™»å…¥å¤±æ•—ï¼š" + e.code; }
    };
    window.logout = async () => { await signOut(auth); };

    // Google ç™»éŒ„
    window.loginWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try { await signInWithPopup(auth, provider); }
      catch (e) { alert("Google ç™»éŒ„å¤±æ•—ï¼š" + e.message); }
    };

    // ===== ä¸»ç¨‹å¼ =====
    let records = [];
    let exportedRecords = [];
    let map, markers = [];
    const GOOGLE_API_KEY = "AIzaSyBH1BUgJopBHGDpvU6f9vGEE7U5DFeF8N4";

    window.addRecord = async function () {
      const nameInput = document.getElementById("storeName");
      const addrInput = document.getElementById("storeAddr");

      const name = nameInput.value.trim();
      const addr = addrInput.value.trim();
      if (!name || !addr) { alert("è«‹è¼¸å…¥åº—åèˆ‡åœ°å€ï¼"); return; }

      const now = new Date();
      const time = now.toLocaleString("zh-TW", { hour12: false });
      const { lng, lat } = await getCoordinates(addr);

      const record = { id: Date.now(), storeName: name, storeAddr: addr, storeTime: time, lng, lat };
      records.push(record);
      saveToLocal();
      updateTable();
      updateMap();
      nameInput.value = ""; addrInput.value = "";
    };

    function updateTable() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      records.forEach(r => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${r.storeName}</td>
          <td>${r.storeAddr}</td>
          <td>${r.storeTime}</td>
          <td>${r.lng}</td>
          <td>${r.lat}</td>
          <td><button class="btn-danger btn-small" onclick="deleteRecord(${r.id})">åˆªé™¤</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateExportedTable() {
      const tbody = document.querySelector("#exportedTable tbody");
      tbody.innerHTML = "";
      exportedRecords.forEach(r => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${r.storeName}</td>
          <td>${r.storeAddr}</td>
          <td>${r.storeTime}</td>
          <td>${r.lng}</td>
          <td>${r.lat}</td>
        `;
        tbody.appendChild(row);
      });
    }

    window.deleteRecord = function (id) {
      records = records.filter(r => r.id !== id);
      saveToLocal(); updateTable(); updateMap();
    };

    // åŒ¯å‡º CSVï¼šå«å¸³è™Ÿï¼Œæª”åå¸¶æ—¥æœŸæ™‚é–“ï¼ŒåŒ¯å‡ºå‰ç¢ºèªï¼ŒåŒ¯å‡ºå¾Œæ¸…ç©ºä¸¦ç§»åˆ°å·²åŒ¯å‡ºæ¸…å–®
    window.exportCSV = function () {
      if (records.length === 0) { alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡ºï¼"); return; }
      if (!confirm("âš ï¸ ç¢ºèªè¦åŒ¯å‡ºä¸¦æ¸…ç©ºæ¸…å–®å—ï¼Ÿ")) return;

      let csv = `å¸³è™Ÿ,${currentUser}\nåº—å,åœ°å€,æ™‚é–“,ç¶“åº¦,ç·¯åº¦\n`;
      records.forEach(r => {
        csv += `"${r.storeName}","${r.storeAddr}","${r.storeTime}",${r.lng},${r.lat}\n`;
      });

      // æª”ååŠ æ™‚é–“æˆ³
      const now = new Date();
      const ts = now.toISOString().slice(0,19).replace("T","_").replace(/:/g,"-");
      const filename = `clawStores_${ts}.csv`;

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);

      exportedRecords.push(...records);
      updateExportedTable();

      records = [];
      saveToLocal();
      updateTable();
      updateMap();
    };

    // æš«å­˜
    function saveToLocal() {
      localStorage.setItem("clawStores", JSON.stringify(records));
    }
    function loadFromLocal() {
      const saved = localStorage.getItem("clawStores");
      records = saved ? JSON.parse(saved) : [];
      updateTable(); updateMap();
    }

    // Google åœ°åœ–
    window.initMap = function () {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 22.6273, lng: 120.3014 }, zoom: 12
      });
      updateMap();
    };

    function updateMap() {
      if (!map) return;
      (markers||[]).forEach(m => m.setMap(null));
      markers = [];
      records.forEach(r => {
        if (r.lat && r.lng) {
          const marker = new google.maps.Marker({
            position: { lat: parseFloat(r.lat), lng: parseFloat(r.lng) },
            map, title: r.storeName
          });
          const info = new google.maps.InfoWindow({
            content: `<b>${r.storeName}</b><br>${r.storeAddr}<br>ğŸ•’ ${r.storeTime}`
          });
          marker.addListener("click", () => info.open(map, marker));
          markers.push(marker);
        }
      });
    }

    // å–ç¶“ç·¯åº¦
    async function getCoordinates(address) {
      try {
        const res = await fetch(
          `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${GOOGLE_API_KEY}`
        );
        const data = await res.json();
        if (data.status === "OK") return data.results[0].geometry.location;
      } catch (err) { console.error(err); }
      return { lng: 0, lat: 0 };
    }
  </script>

  <!-- Google Maps -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBH1BUgJopBHGDpvU6f9vGEE7U5DFeF8N4&callback=initMap"></script>
</body>
</html>
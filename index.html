<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æˆ‘çš„å®šä½</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px 0; padding: 6px 10px; font-size: 14px; cursor: pointer; }
    input { padding: 6px; font-size: 14px; }
    .info { margin-top: 15px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: left; }
    .delete-btn { background: #e74c3c; color: white; border: none; border-radius: 4px; }
    .delete-btn:hover { background: #c0392b; }
    .edit-btn { background: #3498db; color: white; border: none; border-radius: 4px; }
    .edit-btn:hover { background: #2980b9; }
    .clear-btn { background: #f39c12; color: white; border: none; border-radius: 4px; }
    .clear-btn:hover { background: #d35400; }
  </style>
</head>
<body>
  <h2>æˆ‘çš„å®šä½ç¨‹å¼</h2>
  
  <button onclick="getLocation()">ğŸ“ æˆ‘çš„å®šä½</button>
  
  <div class="info">
    <p><strong>åœ°å€ï¼š</strong><span id="address">å°šæœªå–å¾—</span></p>
    <p><strong>ç¶“åº¦ï¼š</strong><span id="lng">-</span></p>
    <p><strong>ç·¯åº¦ï¼š</strong><span id="lat">-</span></p>
  </div>

  <div class="info">
    <label>åº—åï¼š<input type="text" id="storeName" placeholder="è«‹è¼¸å…¥åº—å"></label>
  </div>
  
  <button onclick="addRecord()">â• åŠ å…¥æ¸…å–®</button>
  <button onclick="exportCSV()">â¬‡ åŒ¯å‡º CSV</button>
  <button class="clear-btn" onclick="clearAll()">ğŸ—‘ æ¸…ç©ºæ¸…å–®</button>

  <h3>æš«å­˜æ¸…å–®</h3>
  <table id="dataTable">
    <thead>
      <tr>
        <th>åº—å</th>
        <th>åœ°å€</th>
        <th>ç¶“åº¦</th>
        <th>ç·¯åº¦</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <script>
    let currentAddress = "";
    let currentLat = "";
    let currentLng = "";
    let records = []; // æš«å­˜è³‡æ–™

    // åˆå§‹åŒ–ï¼šè®€å– localStorage
    window.onload = function() {
      const saved = localStorage.getItem("records");
      if (saved) {
        records = JSON.parse(saved);
        updateTable();
      }
    };

    function saveToLocalStorage() {
      localStorage.setItem("records", JSON.stringify(records));
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
      } else {
        alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
      }
    }

    function showPosition(position) {
      currentLat = position.coords.latitude;
      currentLng = position.coords.longitude;
      document.getElementById("lat").innerText = currentLat;
      document.getElementById("lng").innerText = currentLng;

      // Google Maps Geocoding API (éœ€é‡‘é‘°)
      fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${currentLat},${currentLng}&key=AIzaSyBH1BUgJopBHGDpvU6f9vGEE7U5DFeF8N4-g&language=zh-TW`)
        .then(response => response.json())
        .then(data => {
          if (data.results.length > 0) {
            currentAddress = data.results[0].formatted_address;
            document.getElementById("address").innerText = currentAddress;
          } else {
            currentAddress = "æ‰¾ä¸åˆ°åœ°å€";
            document.getElementById("address").innerText = currentAddress;
          }
        });
    }

    function showError(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          alert("ä½¿ç”¨è€…æ‹’çµ•äº†å®šä½è¦æ±‚");
          break;
        case error.POSITION_UNAVAILABLE:
          alert("ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Š");
          break;
        case error.TIMEOUT:
          alert("å®šä½è«‹æ±‚é€¾æ™‚");
          break;
        default:
          alert("æœªçŸ¥éŒ¯èª¤");
          break;
      }
    }

    function addRecord() {
      const storeName = document.getElementById("storeName").value.trim();
      if (!storeName) {
        alert("è«‹è¼¸å…¥åº—åï¼");
        return;
      }
      if (!currentLat || !currentLng || !currentAddress) {
        alert("è«‹å…ˆæŒ‰ã€æˆ‘çš„å®šä½ã€å–å¾—ä½ç½®è³‡è¨Šï¼");
        return;
      }

      const record = {
        storeName,
        address: currentAddress,
        lng: currentLng,
        lat: currentLat
      };
      records.push(record);
      updateTable();
      saveToLocalStorage();
      document.getElementById("storeName").value = "";
    }

    function deleteRecord(index) {
      records.splice(index, 1);
      updateTable();
      saveToLocalStorage();
    }

    function editRecord(index) {
      const tbody = document.querySelector("#dataTable tbody");
      const row = tbody.rows[index];
      const record = records[index];

      row.innerHTML = `
        <td><input type="text" id="editName${index}" value="${record.storeName}"></td>
        <td><input type="text" id="editAddr${index}" value="${record.address}"></td>
        <td><input type="text" id="editLng${index}" value="${record.lng}"></td>
        <td><input type="text" id="editLat${index}" value="${record.lat}"></td>
        <td>
          <button class="edit-btn" onclick="saveRecord(${index})">å„²å­˜</button>
          <button class="delete-btn" onclick="deleteRecord(${index})">åˆªé™¤</button>
        </td>
      `;
    }

    function saveRecord(index) {
      const name = document.getElementById(`editName${index}`).value.trim();
      const addr = document.getElementById(`editAddr${index}`).value.trim();
      const lng = document.getElementById(`editLng${index}`).value.trim();
      const lat = document.getElementById(`editLat${index}`).value.trim();

      if (!name) {
        alert("åº—åä¸å¯ç©ºç™½ï¼");
        return;
      }

      records[index] = { storeName: name, address: addr, lng, lat };
      updateTable();
      saveToLocalStorage();
    }

    function updateTable() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      records.forEach((r, index) => {
        const row = `<tr>
                      <td>${r.storeName}</td>
                      <td>${r.address}</td>
                      <td>${r.lng}</td>
                      <td>${r.lat}</td>
                      <td>
                        <button class="edit-btn" onclick="editRecord(${index})">ç·¨è¼¯</button>
                        <button class="delete-btn" onclick="deleteRecord(${index})">åˆªé™¤</button>
                      </td>
                    </tr>`;
        tbody.innerHTML += row;
      });
    }

    function clearAll() {
      if (records.length === 0) {
        alert("æ¸…å–®å·²ç¶“æ˜¯ç©ºçš„ï¼");
        return;
      }
      if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
        records = [];
        updateTable();
        saveToLocalStorage();
      }
    }

    function exportCSV() {
      if (records.length === 0) {
        alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼");
        return;
      }
      let csvContent = "åº—å,åœ°å€,ç¶“åº¦,ç·¯åº¦\n";
      records.forEach(r => {
        csvContent += `"${r.storeName}","${r.address}",${r.lng},${r.lat}\n`;
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "å¨ƒå¨ƒæ©Ÿæ¸…å–®.csv";
      link.click();
    }
  </script>
</body>
</html>
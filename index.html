<!DOCTYPE html>
<html lang="zh-Hant">
<head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-65GTWZKRV5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-65GTWZKRV5');
</script>
  <meta charset="UTF-8">
  <title>娃娃機清單（專業版）</title>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: #f4f6f8; }
    header { background: #2c3e50; color: white; padding: 15px 20px; font-size: 20px; }

    /* 登錄頁面 */
    .auth-wrapper {
      display: flex; justify-content: center; align-items: center;
      height: 100vh; background: linear-gradient(135deg, #3498db, #8e44ad);
    }
    .auth-card {
      background: white; padding: 40px 35px; border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      width: 100%; max-width: 380px; text-align: center;
    }
    .auth-card h2 { margin-bottom: 10px; color: #2c3e50; }
    .subtitle { margin-bottom: 20px; color: #7f8c8d; font-size: 14px; }
    .auth-card input {
      width: 100%; padding: 12px; margin: 10px 0;
      border: 1px solid #ccc; border-radius: 8px;
    }
    .auth-card button {
      width: 100%; padding: 12px; margin: 8px 0;
      border: none; border-radius: 8px; font-size: 15px;
      cursor: pointer; transition: 0.3s;
    }
    .btn-primary { background: #3498db; color: white; }
    .btn-primary:hover { background: #2980b9; }
    .btn-secondary { background: #2ecc71; color: white; }
    .btn-secondary:hover { background: #27ae60; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }
    .btn-success { background: #2ecc71; color: white; }
    .btn-success:hover { background: #27ae60; }
    .auth-message { margin-top: 15px; font-size: 14px; color: red; }

    /* 主介面 */
    .app-wrapper { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .app-card {
      background: white; padding: 20px; margin-bottom: 20px;
      border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    }
    #map { width: 100%; height: 400px; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f9fafb; }
  </style>
</head>
<body>
  <header>娃娃機清單管理</header>

  <!-- 登錄區 -->
  <div class="auth-wrapper" id="authSection">
    <div class="auth-card">
      <h2>🎮 娃娃機地圖 App</h2>
      <p class="subtitle">請登入以管理您的清單</p>
      <input type="email" id="email" placeholder="電子郵件">
      <input type="password" id="password" placeholder="密碼">
      <button class="btn-primary" onclick="login()">登入</button>
      <button class="btn-secondary" onclick="register()">註冊新帳號</button>
      <p id="authMessage" class="auth-message"></p>
    </div>
  </div>

  <!-- 主功能區 -->
  <div class="app-wrapper" id="appSection" style="display:none;">
    <div class="app-header">
      <h2 id="welcomeText">歡迎！</h2>
      <button class="btn-danger" onclick="logout()">登出</button>
    </div>

    <div class="app-card">
      <h3>➕ 新增店家</h3>
      <input type="text" id="storeName" placeholder="請輸入店名">
      <input type="text" id="storeAddr" placeholder="請輸入地址">
      <button class="btn-primary" onclick="addRecord()">儲存</button>
      <button class="btn-success" onclick="exportData()">匯出 JSON</button>
    </div>

    <div class="app-card">
      <h3>📋 我的清單</h3>
      <table id="dataTable">
        <thead>
          <tr>
            <th>店名</th>
            <th>地址</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="app-card">
      <h3>🗺️ 地圖</h3>
      <div id="map"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB1SOrDItdUUshN2DuijWjdEAbuNXGvY6A",
      authDomain: "clawmachine-68199.firebaseapp.com",
      projectId: "clawmachine-68199",
      storageBucket: "clawmachine-68199.appspot.com",
      messagingSenderId: "416551705279",
      appId: "1:416551705279:web:3ba72ebcc992da5f78440a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const GOOGLE_API_KEY = "AIzaSyBH1BUgJopBHGDpvU6f9vGEE7U5DFeF8N4";

    let records = [];
    let map;
    let markers = [];

    // 認證
    window.register = async function() {
      try {
        await createUserWithEmailAndPassword(auth, email.value, password.value);
        authMessage.textContent = "✅ 註冊成功，請登入";
      } catch (e) {
        authMessage.textContent = "❌ 註冊失敗：" + e.code;
      }
    };
    window.login = async function() {
      try {
        await signInWithEmailAndPassword(auth, email.value, password.value);
      } catch (e) {
        authMessage.textContent = "❌ 登入失敗：" + e.code;
      }
    };
    window.logout = async () => { await signOut(auth); };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authSection.style.display = "none";
        appSection.style.display = "block";
        welcomeText.innerText = `歡迎回來，${user.email}`;
        loadFromLocal();
      } else {
        authSection.style.display = "flex";
        appSection.style.display = "none";
      }
    });

    // 本地清單
    async function addRecord() {
      const name = storeName.value.trim();
      const addr = storeAddr.value.trim();
      if (!name || !addr) return alert("請輸入店名與地址！");

      const { lng, lat } = await getCoordinates(addr);
      const record = { id: Date.now(), storeName: name, storeAddr: addr, lng, lat };
      records.push(record);
      saveToLocal();
      updateTable();
      updateMap();
      storeName.value = ""; storeAddr.value = "";
    }

    function updateTable() {
      dataTable.querySelector("tbody").innerHTML = records.map(r => `
        <tr>
          <td>${r.storeName}</td>
          <td>${r.storeAddr}</td>
          <td><button class="btn-danger" onclick="deleteRecord(${r.id})">刪除</button></td>
        </tr>`).join("");
    }

    window.deleteRecord = function(id) {
      if (!confirm("確定要刪除嗎？")) return;
      records = records.filter(r => r.id !== id);
      saveToLocal(); updateTable(); updateMap();
    };

    function saveToLocal() {
      if (auth.currentUser) {
        localStorage.setItem("clawStores_" + auth.currentUser.uid, JSON.stringify(records));
      }
    }
    function loadFromLocal() {
      if (auth.currentUser) {
        const saved = localStorage.getItem("clawStores_" + auth.currentUser.uid);
        records = saved ? JSON.parse(saved) : [];
        updateTable(); updateMap();
      }
    }

    window.exportData = function() {
      const blob = new Blob([JSON.stringify(records, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "clawStores.json"; a.click();
      URL.revokeObjectURL(url);
    };

    // Google Maps
    window.initMap = function() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 22.6273, lng: 120.3014 }, zoom: 12
      });
    };
    function updateMap() {
      if (!map) return;
      markers.forEach(m => m.setMap(null)); markers = [];
      records.forEach(r => {
        if (r.lat && r.lng) {
          const marker = new google.maps.Marker({
            position: { lat: parseFloat(r.lat), lng: parseFloat(r.lng) },
            map, title: r.storeName
          });
          new google.maps.InfoWindow({ content: `<b>${r.storeName}</b><br>${r.storeAddr}` })
            .open(map, marker);
          markers.push(marker);
        }
      });
    }

    async function getCoordinates(address) {
      try {
        const res = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${GOOGLE_API_KEY}`);
        const data = await res.json();
        if (data.status === "OK") return data.results[0].geometry.location;
        alert("地址轉換失敗：" + data.status);
      } catch (err) { console.error(err); }
      return { lng: 0, lat: 0 };
    }
  </script>

  <!-- Google Maps -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBH1BUgJopBHGDpvU6f9vGEE7U5DFeF8N4&callback=initMap"></script>
</body>
</html>
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åˆ®åˆ®å¡</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(0,0,0,.10);
      --shadow:0 10px 24px rgba(0,0,0,.10);
      --btn:#f3f4f6;
      --btnHover:#e5e7eb;
      --primary:#2563eb;
      --danger:#ef4444;
      --win:#f59e0b;
      --covered:#000000;
      --cellSize: 40px; /* JS æœƒå‹•æ…‹æ›´æ–° */
      --gap: 10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
        "Noto Sans TC","PingFang TC","Microsoft JhengHei", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{max-width:1120px;margin:22px auto;padding:0 14px}
    header{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      padding:14px 14px;
      background: var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.5}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      border:1px solid var(--border);
      background: var(--btn);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    button:hover{background: var(--btnHover)}
    button:active{transform: translateY(1px)}
    button.primary{border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.08)}
    button.primary:hover{background: rgba(37,99,235,.12)}
    button.danger{border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.08)}
    button.danger:hover{background: rgba(239,68,68,.12)}

    .layout{margin-top:14px;display:grid;grid-template-columns: 1fr;gap:14px}
    @media (min-width: 980px){
      /* å·¦é‚Šæ›´å¤§ã€å³é‚Šæ›´çª„ */
      .layout{grid-template-columns: 1.45fr .55fr}
    }

    .panel{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }
    .panelTitle{font-size:13px;color:var(--muted)}
    .stats{font-size:13px;color:var(--muted)}

    .board{
      padding:12px;
      display:grid;
      gap: var(--gap);
      justify-content: center;
      align-content: start;
    }

    .cell{
      width: var(--cellSize);
      height: var(--cellSize);
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size: calc(var(--cellSize) * 0.38); /* æ•¸å­—æ¯”åœ“å½¢å°ä¸€é» */
      line-height: 1;
      border:1px solid var(--border);
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .cell.covered{
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.10), rgba(255,255,255,.03) 45%, rgba(0,0,0,.25) 72%), var(--covered);
      color: transparent;
    }
    .cell.covered:hover{filter:brightness(1.05)}
    .cell.revealed{
      background:#ffffff;
      color: var(--text);
      cursor: default;
    }
    .cell.revealed.win{
      border-color: rgba(245,158,11,.65);
      box-shadow: 0 10px 20px rgba(245,158,11,.16), 0 10px 20px rgba(0,0,0,.10);
    }

    .side{padding:12px 14px;display:grid;gap:12px}
    .box{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background: rgba(0,0,0,.02);
    }
    .box h2{margin:0 0 8px 0;font-size:13px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);line-height:1.55}

    .winList{display:flex;flex-wrap:wrap;gap:8px;min-height:28px}
    .pill{
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.02);
      color: var(--text);
    }
    .pill.hit{border-color: rgba(245,158,11,.65); background: rgba(245,158,11,.12)}

    /* ğŸ“± å…¨è¢å¹• UIï¼ˆUI æ”¾å¤§/è²¼é½Šï¼‰ */
    .fullscreenOn .wrap{max-width:100%;margin:0;padding:10px}
    .fullscreenOn header{position:sticky;top:0;z-index:20}
    body.fullscreenOn{ --gap: 8px; }

    @media (max-width: 520px){
      :root{ --gap: 8px; }
      button{padding:10px 10px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1 id="title">åˆ®åˆ®å¡ï¼ˆ1â€“160ï¼‰</h1>
        <div class="sub" id="subtitle">ç‰ˆé¢ï¼š<b>10 æ’ Ã— 16 åˆ—</b>ï¼ˆå…± 160 æ ¼ï¼‰ã€‚ä¸”<b>ä¸å¯å¾©åŸ</b>ã€‚</div>
      </div>
      <div class="controls">
        <button class="primary" id="btnRandom" type="button">ğŸ² éš¨æ©Ÿé¸è™Ÿ</button>
        <button class="primary" id="btnPick" type="button">ğŸ§· æŒ‡å®šé¸è™Ÿ</button>
        <button class="primary" id="btnSize" type="button">ğŸ§© æ›´æ›æ´æ•¸</button>
        <button class="danger" id="btnReset" type="button">ğŸ” æ›ç‰ˆ</button>
        <button class="primary" id="btnFullscreen" type="button">ğŸ“± å…¨è¢å¹•ï¼šé—œ</button>
      </div>
    </header>

    <div class="layout">
      <section class="panel" id="leftPanel">
        <div class="panelHead">
          <div class="panelTitle">åˆ®å¡ç‰ˆé¢</div>
          <div class="stats" id="stats">å·²åˆ®é–‹ 0 / 160ï¼ˆå‰©é¤˜ 160ï¼‰</div>
        </div>
        <div class="board" id="board"></div>
      </section>

      <aside class="panel">
        <div class="panelHead">
          <div class="panelTitle">ä¸­çè³‡è¨Š</div>
          <div class="stats" id="winStats">ä¸­çè™Ÿç¢¼ 0 å€‹</div>
        </div>
        <div class="side">
          <div class="box">
            <h2>ä¸­çè™Ÿç¢¼æ¸…å–®</h2>
            <div class="winList" id="winList"></div>
            <div class="hint" style="margin-top:10px;">
              â€¢ <br>
              â€¢ <br>
              â€¢ <br>
              â€¢ 
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
  (() => {
    // ===== å¯æ”¹è¨­å®š =====
    const PASSWORD = "911021";
    const STORAGE_KEY = "scratchcard_persist_v2"; // æ›æ–° key é¿å…ä½ ä¹‹å‰å£è³‡æ–™å½±éŸ¿

    // æ´æ•¸ï¼šæ’xåˆ—ï¼ˆrows x colsï¼‰
    const SIZE_PRESETS = [
      { total: 20,  rows: 4,  cols: 5  },
      { total: 40,  rows: 5,  cols: 8  },
      { total: 60,  rows: 6,  cols: 10 },
      { total: 80,  rows: 8,  cols: 10 },
      { total: 100, rows: 10, cols: 10 },
      { total: 120, rows: 10, cols: 12 },
      { total: 160, rows: 10, cols: 16 },
    ];

    // ===== DOM =====
    const $ = (id) => document.getElementById(id);

    const boardEl = $("board");
    const statsEl = $("stats");
    const winListEl = $("winList");
    const winStatsEl = $("winStats");
    const titleEl = $("title");
    const subtitleEl = $("subtitle");

    const btnRandom = $("btnRandom");
    const btnPick = $("btnPick");
    const btnReset = $("btnReset");
    const btnSize = $("btnSize");
    const btnFullscreen = $("btnFullscreen");

    // ===== State =====
    let current = { total: 160, rows: 10, cols: 16 };
    let order = [];              // äº‚ç¢¼é †åºï¼ˆå›ºå®šä¿å­˜ï¼‰
    const revealed = new Set();  // å·²åˆ®é–‹
    const winning = new Set();   // ä¸­çè™Ÿç¢¼
    let isFullscreenUI = false;

    // ===== Utils =====
    function safeJsonParse(raw){
      try { return JSON.parse(raw); } catch { return null; }
    }

    function savePersist(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        current,
        order,
        revealed: Array.from(revealed),
        winning: Array.from(winning),
        isFullscreenUI
      }));
    }

    function loadPersist(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const s = safeJsonParse(raw);
      if (!s || typeof s !== "object") return;

      // current
      if (s.current && typeof s.current === "object") {
        const t = Number(s.current.total);
        const r = Number(s.current.rows);
        const c = Number(s.current.cols);
        const preset = SIZE_PRESETS.find(p => p.total === t && p.rows === r && p.cols === c);
        if (preset) current = { ...preset };
      }

      // order / revealed / winning
      if (Array.isArray(s.order)) order = s.order.slice();
      if (Array.isArray(s.revealed)) s.revealed.forEach(n => {
        const x = Number(n); if (Number.isFinite(x)) revealed.add(x);
      });
      if (Array.isArray(s.winning)) s.winning.forEach(n => {
        const x = Number(n); if (Number.isFinite(x)) winning.add(x);
      });

      // fullscreen
      isFullscreenUI = !!s.isFullscreenUI;
      document.body.classList.toggle("fullscreenOn", isFullscreenUI);
      btnFullscreen.textContent = `ğŸ“± å…¨è¢å¹•ï¼š${isFullscreenUI ? "é–‹" : "é—œ"}`;

      // sanitize
      if (order.length !== current.total) order = [];
      for (const n of Array.from(revealed)) if (n < 1 || n > current.total) revealed.delete(n);
      for (const n of Array.from(winning))  if (n < 1 || n > current.total) winning.delete(n);
    }

    function requirePassword(){
      const p = prompt("è«‹è¼¸å…¥å¯†ç¢¼ï¼š");
      if (p === null) return false;
      if (p !== PASSWORD) { alert("å¯†ç¢¼éŒ¯èª¤"); return false; }
      return true;
    }

    function clampInt(n, min, max){
      const x = Number.parseInt(String(n), 10);
      if (!Number.isFinite(x)) return null;
      return Math.max(min, Math.min(max, x));
    }

    function sortedSet(set){
      return Array.from(set).sort((a,b)=>a-b);
    }

    function shuffleArray(arr){
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function makeShuffledNumbers(total){
      return shuffleArray(Array.from({length: total}, (_,i)=>i+1));
    }

    // ===== Layout fit =====
    function fitBoardToViewport(){
      const rootStyles = getComputedStyle(document.documentElement);
      const gap = parseFloat(rootStyles.getPropertyValue("--gap")) || 10;

      const boardRect = boardEl.getBoundingClientRect();
      const availableW = Math.max(0, boardRect.width);

      const headerEl = document.querySelector("header");
      const headerH = headerEl ? headerEl.getBoundingClientRect().height : 0;
      const panelHeadEl = document.querySelector("#leftPanel .panelHead");
      const panelHeadH = panelHeadEl ? panelHeadEl.getBoundingClientRect().height : 0;

      const extra = 28;
      const availableH = Math.max(160, window.innerHeight - headerH - panelHeadH - extra);

      const cols = current.cols;
      const rows = current.rows;

      const sizeByW = (availableW - gap * (cols - 1)) / cols;
      const sizeByH = (availableH - gap * (rows - 1)) / rows;

      let cell = Math.floor(Math.min(sizeByW, sizeByH));
      cell = Math.max(18, Math.min(cell, 72));

      document.documentElement.style.setProperty("--cellSize", cell + "px");
      boardEl.style.gridTemplateColumns = `repeat(${cols}, var(--cellSize))`;
    }

    // ===== Render =====
    function updateHeader(){
      titleEl.textContent = `åˆ®åˆ®å¡ï¼ˆ1â€“${current.total}ï¼‰`;
      subtitleEl.innerHTML = `ç‰ˆé¢ï¼š<b>${current.rows} æ’ Ã— ${current.cols} åˆ—</b>ï¼ˆå…± ${current.total} æ ¼ï¼‰ã€‚æœªåˆ®é–‹ç‚ºé»‘è‰²åœ“å½¢ï¼›é»æ“Šå¾Œé¡¯ç¤ºè™Ÿç¢¼ï¼Œä¸”<b>ä¸å¯å¾©åŸ</b>ã€‚`;
    }

    function updateStats(){
      const remaining = current.total - revealed.size;
      statsEl.textContent = `å·²åˆ®é–‹ ${revealed.size} / ${current.total}ï¼ˆå‰©é¤˜ ${remaining}ï¼‰`;
    }

    function renderWinList(){
      const wins = sortedSet(winning);
      winStatsEl.textContent = `ä¸­çè™Ÿç¢¼ ${wins.length} å€‹`;

      winListEl.innerHTML = "";
      if (wins.length === 0){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "å°šæœªè¨­å®šä¸­çè™Ÿç¢¼";
        winListEl.appendChild(empty);
        return;
      }

      for (const n of wins){
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = String(n);
        if (revealed.has(n)) pill.classList.add("hit");
        winListEl.appendChild(pill);
      }
    }

    function buildBoard(){
      boardEl.innerHTML = "";

      if (!Array.isArray(order) || order.length !== current.total){
        order = makeShuffledNumbers(current.total);
      }

      boardEl.style.gridTemplateColumns = `repeat(${current.cols}, var(--cellSize))`;

      for (const num of order){
        const cell = document.createElement("button");
        cell.type = "button";
        cell.className = "cell";
        cell.dataset.num = String(num);
        cell.textContent = String(num);

        if (!revealed.has(num)) {
          cell.classList.add("covered");
        } else {
          cell.classList.add("revealed");
          if (winning.has(num)) cell.classList.add("win");
        }

        cell.addEventListener("click", () => {
          const n = Number(cell.dataset.num);
          if (revealed.has(n)) return;

          revealed.add(n);
          cell.classList.remove("covered");
          cell.classList.add("revealed");
          if (winning.has(n)) cell.classList.add("win");

          updateStats();
          renderWinList();
          savePersist();
        });

        boardEl.appendChild(cell);
      }

      updateHeader();
      updateStats();
      renderWinList();
      fitBoardToViewport();
      savePersist();
    }

    function refreshWinningHighlights(){
      for (const node of boardEl.querySelectorAll(".cell")){
        const n = Number(node.dataset.num);
        if (!revealed.has(n)) continue;
        if (winning.has(n)) node.classList.add("win");
        else node.classList.remove("win");
      }
      renderWinList();
      savePersist();
    }

    // ===== Actions =====
    function pickRandomWinners(){
      if (!requirePassword()) return;

      const raw = prompt(`è¦éš¨æ©Ÿé¸å¹¾å€‹ä¸­çè™Ÿç¢¼ï¼Ÿï¼ˆ1â€“${current.total}ï¼‰`, "1");
      if (raw === null) return;

      const count = clampInt(raw, 1, current.total);
      if (count === null) { alert("è«‹è¼¸å…¥æ•¸å­—"); return; }

      const pool = [];
      for (let i = 1; i <= current.total; i++){
        if (!winning.has(i)) pool.push(i);
      }
      if (pool.length === 0){ alert(`ç›®å‰ 1â€“${current.total} å·²å…¨éƒ¨è¨­ç‚ºä¸­çè™Ÿç¢¼äº†`); return; }

      shuffleArray(pool);
      const k = Math.min(count, pool.length);
      for (let i = 0; i < k; i++) winning.add(pool[i]);

      refreshWinningHighlights();
    }

    function pickSpecificWinners(){
      if (!requirePassword()) return;

      const raw = prompt(
        `è¼¸å…¥è¦æŒ‡å®šçš„ä¸­çè™Ÿç¢¼ï¼ˆ1â€“${current.total}ï¼Œå¯ç”¨é€—è™Ÿæˆ–ç©ºç™½åˆ†éš”ï¼‰\nä¾‹å¦‚ï¼š1, 16, 88`,
        ""
      );
      if (raw === null) return;

      const parts = raw.replaceAll(",", " ").split(" ").map(s=>s.trim()).filter(Boolean);
      if (parts.length === 0){ alert("æ²’æœ‰è®€åˆ°ä»»ä½•è™Ÿç¢¼"); return; }

      const nums = parts.map(s=>Number.parseInt(s,10)).filter(Number.isFinite);
      if (nums.length === 0){ alert("æ²’æœ‰è®€åˆ°ä»»ä½•æœ‰æ•ˆæ•¸å­—"); return; }

      const bad = nums.filter(n => n < 1 || n > current.total);
      if (bad.length){ alert(`ä»¥ä¸‹è™Ÿç¢¼è¶…å‡ºç¯„åœï¼ˆ1â€“${current.total}ï¼‰ï¼š${bad.join(", ")}`); return; }

      for (const n of nums) winning.add(n);
      refreshWinningHighlights();
    }

    function resetBoard(){
      if (!requirePassword()) return;
      const ok = confirm("ç¢ºå®šè¦æ›ç‰ˆå—ï¼Ÿ\nï¼ˆæœƒæ¸…ç©ºä¸­çè™Ÿç¢¼èˆ‡æ‰€æœ‰åˆ®é–‹ç‹€æ…‹ï¼‰");
      if (!ok) return;

      revealed.clear();
      winning.clear();
      order = makeShuffledNumbers(current.total);

      buildBoard();
    }

    function changeSize(){
      if (!requirePassword()) return;

      const lines = SIZE_PRESETS
        .map((s, idx) => `${idx+1}. ${s.total} æ´ï¼ˆ${s.rows} æ’ x ${s.cols} åˆ—ï¼‰`)
        .join("\n");

      const raw = prompt(
        `é¸æ“‡æ´æ•¸ï¼š\n${lines}\n\nè«‹è¼¸å…¥ 1-${SIZE_PRESETS.length}ï¼š`,
        String(SIZE_PRESETS.length)
      );
      if (raw === null) return;

      const pick = clampInt(raw, 1, SIZE_PRESETS.length);
      if (pick === null){ alert("è«‹è¼¸å…¥æ•¸å­—"); return; }

      current = { ...SIZE_PRESETS[pick - 1] };
      revealed.clear();
      winning.clear();
      order = makeShuffledNumbers(current.total);

      buildBoard();
    }

    async function toggleFullscreenUI(){
      isFullscreenUI = !isFullscreenUI;
      document.body.classList.toggle("fullscreenOn", isFullscreenUI);
      btnFullscreen.textContent = `ğŸ“± å…¨è¢å¹•ï¼š${isFullscreenUI ? "é–‹" : "é—œ"}`;

      fitBoardToViewport();
      savePersist();

      // å˜—è©¦çœŸå…¨è¢å¹•ï¼ˆè‹¥ç€è¦½å™¨ä¸æ”¯æ´ä¹Ÿæ²’é—œä¿‚ï¼‰
      try{
        if (isFullscreenUI && document.documentElement.requestFullscreen) {
          await document.documentElement.requestFullscreen();
        }
        if (!isFullscreenUI && document.fullscreenElement) {
          await document.exitFullscreen();
        }
      } catch {}
    }

    // ===== Wire up =====
    function runSelfTests(){
      const assert = (cond, msg) => { if (!cond) console.warn("TEST FAIL:", msg); };
      assert(!!boardEl && !!btnRandom && !!btnPick && !!btnReset && !!btnSize, "DOM ids missing");
      assert(SIZE_PRESETS.some(p=>p.total===160), "SIZE_PRESETS should include 160");
      assert(current.total === current.rows * current.cols, "current total should equal rows*cols");
    }

    function init(){
      // å¦‚æœä½ ä¹‹å‰å­˜éå£è³‡æ–™ï¼Œé€™è£¡ä¿åº•ï¼šDOM ä¸å­˜åœ¨å°±ç›´æ¥åœ
      if (!boardEl || !btnRandom || !btnPick || !btnReset || !btnSize || !btnFullscreen) {
        alert("é é¢ç¼ºå°‘å¿…è¦å…ƒä»¶ï¼ˆDOM id ä¸å­˜åœ¨ï¼‰ï¼Œè«‹ç¢ºèªä½ æ˜¯æ•´ä»½ HTML è²¼ä¸Šã€‚");
        return;
      }

      loadPersist();
      runSelfTests();

      btnRandom.addEventListener("click", pickRandomWinners);
      btnPick.addEventListener("click", pickSpecificWinners);
      btnReset.addEventListener("click", resetBoard);
      btnSize.addEventListener("click", changeSize);
      btnFullscreen.addEventListener("click", toggleFullscreenUI);

      window.addEventListener("resize", fitBoardToViewport);

      document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement && isFullscreenUI) {
          isFullscreenUI = false;
          document.body.classList.remove("fullscreenOn");
          btnFullscreen.textContent = "ğŸ“± å…¨è¢å¹•ï¼šé—œ";
          fitBoardToViewport();
          savePersist();
        }
      });

      buildBoard();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
  </script>
</body>
</html>
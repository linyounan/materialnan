<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åˆ®åˆ®å¡</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(0,0,0,.10);
      --shadow:0 10px 24px rgba(0,0,0,.10);
      --btn:#f3f4f6;
      --btnHover:#e5e7eb;
      --primary:#2563eb;
      --danger:#ef4444;
      --win:#f59e0b;
      --covered:#000000;
      --cellSize: 40px;
      --gap: 10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--text);
      user-select:none;-webkit-user-select:none;-ms-user-select:none;
      -webkit-tap-highlight-color:transparent;
    }

    .wrap{max-width:1120px;margin:22px auto;padding:0 14px}
    header{display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap;align-items:flex-start;padding:14px;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    h1{margin:0;font-size:18px}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.5}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{border:1px solid var(--border);background:var(--btn);padding:10px 12px;border-radius:12px;cursor:pointer;user-select:none}
    button:hover{background:var(--btnHover)}
    button.primary{background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.30)}
    button.danger{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.30)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .panel{margin-top:14px;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .panelHead{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .label,.stats{font-size:13px;color:var(--muted)}

    .winStrip{padding:12px 14px;border-bottom:1px solid var(--border)}
    .winList{display:flex;flex-wrap:wrap;gap:8px;min-height:28px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:13px;background:rgba(0,0,0,.02)}
    .pill.hit{border-color:rgba(245,158,11,.65);background:rgba(245,158,11,.12)}
    .hint{font-size:12px;color:var(--muted);line-height:1.55;margin-top:8px;white-space:pre-line}

    .board{padding:12px;display:grid;gap:var(--gap);justify-content:center;min-height:60vh}
    .cell{
      width:var(--cellSize);height:var(--cellSize);
      border-radius:50%;display:flex;align-items:center;justify-content:center;
      font-weight:800;
      font-size:calc(var(--cellSize) * .34);
      border:1px solid var(--border);
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.12);
    }
    .cell.covered{background:var(--covered);color:transparent}
    .cell.revealed{background:#fff;color:var(--text);cursor:default}
    .cell.revealed.win{border-color:var(--win);box-shadow:0 10px 20px rgba(245,158,11,.16),0 10px 20px rgba(0,0,0,.10)}

    /* Modal */
    .modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modalOverlay.show{display:flex}
    .modal{width:min(560px,100%);background:#fff;border-radius:16px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden}
    .modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)}
    .modalTitle{font-weight:700}
    .modalBody{padding:14px;display:grid;gap:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.grid{grid-template-columns:1fr}}

    /* Scratch modal */
    .scratchWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .scratchStage{position:relative;width:min(360px, 84vw);aspect-ratio:1/1}
    .scratchNumber{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;color:#111;z-index:0;opacity:.18;user-select:none}
    .scratchCanvas{position:absolute;inset:0;z-index:2;border-radius:50%;touch-action:none;background:transparent}
    .scratchProg{font-size:12px;color:var(--muted)}

    /* Debug errors */
    .err{position:fixed;left:10px;right:10px;bottom:10px;background:#111;color:#fff;padding:10px 12px;border-radius:12px;font-size:12px;display:none;z-index:2000;white-space:pre-wrap}
    .err.show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1 id="title">åˆ®åˆ®å¡ï¼ˆ1â€“160ï¼‰</h1>
        <div class="sub" id="subtitle">ç‰ˆé¢ï¼š<b>10 æ’ Ã— 16 åˆ—</b>ï¼ˆå…± 160 æ ¼ï¼‰ã€‚</div>
      </div>
      <div class="controls">
        <button id="btnFullscreen" type="button">â›¶ å…¨è¢å¹•</button>
        <button class="primary" id="btnSettings" type="button">âš™ï¸ è¨­å®š</button>
      </div>
    </header>

    <section class="panel" id="panel">
      <div class="panelHead">
        <div class="label">åˆ®å¡ç‰ˆé¢ <span class="stats" id="stats">å·²åˆ® 0 / 160</span></div>
        <div class="stats" id="winStats">ä¸­ç 0 å€‹</div>
      </div>

      <div class="winStrip">
        <div class="winList" id="winList"></div>
        <div class="hint">
      </div>
      </div>

      <div class="board" id="board"></div>
    </section>
  </div>

  <!-- è¨­å®šè¦–çª— -->
  <div class="modalOverlay" id="settingsOverlay" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="settingsTitle">è¨­å®š</div>
        <button type="button" id="btnCloseSettings">âœ–</button>
      </div>
      <div class="modalBody">
        <div class="grid">
          <button class="primary" type="button" id="btnRandom">ğŸ² éš¨æ©Ÿé¸è™Ÿ</button>
          <button class="primary" type="button" id="btnPick">ğŸ§· æŒ‡å®šé¸è™Ÿ</button>
          <button class="primary" type="button" id="btnSize">ğŸ§© æ›´æ›æ´æ•¸</button>
          <button class="danger" type="button" id="btnReset">ğŸ” æ›ç‰ˆ</button>
        </div>
        <div class="hint">å¯†ç¢¼æ­£ç¢ºæ‰æœƒé€²åˆ°é€™è£¡ã€‚
ã€Œæ›´æ›æ´æ•¸ / æ›ç‰ˆã€æœƒæ¸…ç©ºæœ¬å±€ï¼ˆä¸­çèˆ‡å·²åˆ®ï¼‰ã€‚</div>
      </div>
    </div>
  </div>

  <!-- åˆ®å¡æ”¾å¤§è¦–çª— -->
  <div class="modalOverlay" id="scratchOverlay" role="dialog" aria-modal="true" aria-labelledby="scratchTitle">
    <div class="modal" style="max-width:540px">
      <div class="modalHead">
        <div class="modalTitle" id="scratchTitle">åˆ®é–‹</div>
        <button type="button" id="btnScratchClose">âœ–</button>
      </div>
      <div class="modalBody">
        <div class="scratchWrap">
          <div class="scratchStage" id="scratchStage">
            <div class="scratchNumber" id="scratchNumber"></div>
            <canvas class="scratchCanvas" id="scratchCanvas" width="300" height="300"></canvas>
          </div>
          <div class="scratchProg" id="scratchProg">åˆ®é–‹é€²åº¦ï¼š0%ï¼ˆè‡³å°‘ 10% æ‰èƒ½ç¢ºèªï¼‰</div>
          <div class="grid" style="width:100%">
            <button id="btnScratchCancel" type="button">å–æ¶ˆ</button>
            <button class="primary" id="btnScratchConfirm" type="button" disabled>ç¢ºèªåˆ®é–‹</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="err" id="errBox"></div>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // ===== é˜²æ­¢è¤‡è£½/å³éµï¼ˆæ³¨æ„ï¼šç„¡æ³• 100% é˜²æ­¢ï¼Œä½†å¯é™ä½ï¼‰ =====
    document.addEventListener('contextmenu', function(e){ e.preventDefault(); });
    document.addEventListener('copy', function(e){ e.preventDefault(); });
    document.addEventListener('cut', function(e){ e.preventDefault(); });
    document.addEventListener('selectstart', function(e){ e.preventDefault(); });
    document.addEventListener('keydown', function(e){
      var key = (e.key || '').toLowerCase();
      if ((e.ctrlKey || e.metaKey) && (key === 'c' || key === 'x' || key === 'a' || key === 's' || key === 'p')){
        e.preventDefault();
      }
    });

    // ===== åŸºæœ¬è¨­å®š =====
    var PASSWORD = '911021';
    var STORAGE_KEY = 'scratchcard_state_v8';
    var SCRATCH_CONFIRM_THRESHOLD = 10; // %

    var SIZE_PRESETS = [
      {total:20,rows:4,cols:5},
      {total:40,rows:5,cols:8},
      {total:60,rows:6,cols:10},
      {total:80,rows:8,cols:10},
      {total:100,rows:10,cols:10},
      {total:120,rows:10,cols:12},
      {total:160,rows:10,cols:16}
    ];

    // ===== DOM =====
    function $(id){ return document.getElementById(id); }
    var board = $('board');
    var stats = $('stats');
    var winStats = $('winStats');
    var winList = $('winList');
    var titleEl = $('title');
    var subtitleEl = $('subtitle');

    var btnFullscreen = $('btnFullscreen');
    var btnSettings = $('btnSettings');
    var settingsOverlay = $('settingsOverlay');
    var btnCloseSettings = $('btnCloseSettings');

    var btnRandom = $('btnRandom');
    var btnPick = $('btnPick');
    var btnSize = $('btnSize');
    var btnReset = $('btnReset');

    var scratchOverlay = $('scratchOverlay');
    var scratchStage = $('scratchStage');
    var scratchNumber = $('scratchNumber');
    var scratchCanvas = $('scratchCanvas');
    var scratchProg = $('scratchProg');
    var btnScratchCancel = $('btnScratchCancel');
    var btnScratchConfirm = $('btnScratchConfirm');
    var btnScratchClose = $('btnScratchClose');

    var errBox = $('errBox');
    function showErr(msg){
      errBox.textContent = 'âš ï¸ ' + msg;
      errBox.className = 'err show';
    }
    window.addEventListener('error', function(e){
      showErr((e && e.message) ? e.message : 'unknown error');
    });

    if (!board || !btnSettings || !settingsOverlay || !scratchCanvas) {
      showErr('DOM å…ƒä»¶ç¼ºå¤±ï¼Œè«‹ç¢ºèªæ•´ä»½æª”æ¡ˆå®Œæ•´è²¼ä¸Š');
      return;
    }

    // ===== State =====
    var current = {total:160,rows:10,cols:16};
    var order = [];
    var revealed = {}; // num -> 1
    var winning = {};  // num -> 1

    // ===== Utils =====
    function safeParse(raw){ try { return JSON.parse(raw); } catch(e){ return null; } }

    function shuffle(total){
      var arr = [];
      for (var i=1;i<=total;i++) arr.push(i);
      for (var j=arr.length-1;j>0;j--){
        var x = Math.floor(Math.random()*(j+1));
        var tmp = arr[j]; arr[j]=arr[x]; arr[x]=tmp;
      }
      return arr;
    }

    function sortedKeys(obj){
      var keys = [];
      for (var k in obj) keys.push(+k);
      keys.sort(function(a,b){return a-b;});
      return keys;
    }

    function save(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          current: current,
          order: order,
          revealed: Object.keys(revealed),
          winning: Object.keys(winning)
        }));
      }catch(e){ /* ignore */ }
    }

    function load(){
      var raw = null;
      try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){ raw = null; }
      if (!raw) return;

      var s = safeParse(raw);
      if (!s || typeof s !== 'object') return;

      if (s.current && typeof s.current === 'object'){
        var t = Number(s.current.total), r = Number(s.current.rows), c = Number(s.current.cols);
        for (var i=0;i<SIZE_PRESETS.length;i++){
          var p = SIZE_PRESETS[i];
          if (p.total===t && p.rows===r && p.cols===c){
            current = {total:p.total,rows:p.rows,cols:p.cols};
            break;
          }
        }
      }

      if (Array.isArray(s.order)){
        order = [];
        for (var j=0;j<s.order.length;j++){
          var n = Number(s.order[j]);
          if (isFinite(n)) order.push(n);
        }
      }

      revealed = {};
      winning = {};

      if (Array.isArray(s.revealed)){
        for (var a=0;a<s.revealed.length;a++){
          var rn = Number(s.revealed[a]);
          if (isFinite(rn)) revealed[rn] = 1;
        }
      }

      if (Array.isArray(s.winning)){
        for (var b=0;b<s.winning.length;b++){
          var wn = Number(s.winning[b]);
          if (isFinite(wn)) winning[wn] = 1;
        }
      }

      if (!order || order.length !== current.total) order = [];
      for (var k in revealed){ if (+k<1 || +k>current.total) delete revealed[k]; }
      for (var m in winning){ if (+m<1 || +m>current.total) delete winning[m]; }
    }

    function requirePwdOnce(){
      var p = prompt('è«‹è¼¸å…¥å¯†ç¢¼');
      if (p === null) return false;
      if (p !== PASSWORD){ alert('å¯†ç¢¼éŒ¯èª¤'); return false; }
      return true;
    }

    // ===== Layout sizing =====
    function fitCellSize(){
      try{
        var gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 10;
        var boardRect = board.getBoundingClientRect();
        var availableW = Math.max(0, boardRect.width);

        var header = document.querySelector('header');
        var panelHead = document.querySelector('#panel .panelHead');
        var winStrip = document.querySelector('.winStrip');

        var headerH = header ? header.getBoundingClientRect().height : 0;
        var panelHeadH = panelHead ? panelHead.getBoundingClientRect().height : 0;
        var winStripH = winStrip ? winStrip.getBoundingClientRect().height : 0;

        var extra = 28;
        var availableH = Math.max(180, window.innerHeight - headerH - panelHeadH - winStripH - extra);

        var cols = current.cols;
        var rows = current.rows;
        var sizeByW = (availableW - gap*(cols-1))/cols;
        var sizeByH = (availableH - gap*(rows-1))/rows;
        var cell = Math.floor(Math.min(sizeByW, sizeByH));
        if (!isFinite(cell)) cell = 40;
        cell = Math.max(18, Math.min(cell, 72));

        document.documentElement.style.setProperty('--cellSize', cell + 'px');
        board.style.gridTemplateColumns = 'repeat(' + cols + ', var(--cellSize))';
      }catch(e){
        showErr('fitCellSize: ' + (e.message || 'error'));
      }
    }

    // ===== UI render =====
    function updateHeader(){
      titleEl.textContent = 'åˆ®åˆ®å¡ï¼ˆ1â€“' + current.total + 'ï¼‰';
      subtitleEl.innerHTML = 'ç‰ˆé¢ï¼š<b>' + current.rows + ' æ’ Ã— ' + current.cols + ' åˆ—</b>ï¼ˆå…± ' + current.total + ' æ ¼ï¼‰ã€‚é»æ´ â†’ é€²å…¥åˆ®å¡è¦–çª—ï¼Œç”¨æ‰‹æ»‘åˆ®ï¼Œåˆ®åˆ° ' + SCRATCH_CONFIRM_THRESHOLD + '% æ‰èƒ½æŒ‰ã€Œç¢ºèªåˆ®é–‹ã€ã€‚';
    }

    function updateStats(){
      var count = 0;
      for (var k in revealed) count++;
      stats.textContent = 'å·²åˆ® ' + count + ' / ' + current.total;
    }

    function renderWinList(){
      var wins = sortedKeys(winning);
      winStats.textContent = 'ä¸­ç ' + wins.length + ' å€‹';
      winList.innerHTML = '';

      if (!wins.length){
        var span = document.createElement('span');
        span.className = 'pill';
        span.textContent = 'å°šæœªè¨­å®šä¸­çè™Ÿç¢¼';
        winList.appendChild(span);
        return;
      }

      for (var i=0;i<wins.length;i++){
        var n = wins[i];
        var p = document.createElement('span');
        p.className = 'pill' + (revealed[n] ? ' hit' : '');
        p.textContent = String(n);
        winList.appendChild(p);
      }
    }

    // ===== Scratch modal =====
    var sctx = scratchCanvas.getContext('2d');
    var scratchActive = false;
    var currentScratchNum = null;
    var currentScratchPercent = 0;
    var hasScratched = false;
    var lastX = null;
    var lastY = null;

    function setScratchCanvasSize(){
      var rect = scratchStage.getBoundingClientRect();
      var size = Math.floor(Math.min(rect.width, rect.height));
      if (size < 220) size = 220;
      scratchCanvas.width = size;
      scratchCanvas.height = size;
      scratchNumber.style.fontSize = Math.floor(size * 0.26) + 'px';
    }

    function scratchMask(){
      var w = scratchCanvas.width;
      var h = scratchCanvas.height;
      sctx.globalCompositeOperation = 'source-over';
      sctx.clearRect(0,0,w,h);
      sctx.fillStyle = '#000';
      sctx.beginPath();
      sctx.arc(w/2, h/2, Math.min(w,h)/2, 0, Math.PI*2);
      sctx.fill();
      sctx.globalCompositeOperation = 'destination-out';
    }

    function getScratchPercent(){
      var w = scratchCanvas.width;
      var h = scratchCanvas.height;
      var data;
      try{ data = sctx.getImageData(0,0,w,h).data; }
      catch(e){ return 0; }

      // å–æ¨£ä¼°ç®—é€æ˜æ¯”ä¾‹
      var step = Math.max(4, Math.floor(w / 90));
      var total = 0;
      var clear = 0;
      for (var y=0; y<h; y+=step){
        for (var x=0; x<w; x+=step){
          var idx = (y*w + x) * 4 + 3;
          total++;
          if (data[idx] === 0) clear++;
        }
      }
      if (!total) return 0;
      return Math.round((clear/total) * 100);
    }

    function updateScratchProgress(){
      currentScratchPercent = getScratchPercent();
      scratchProg.textContent = 'åˆ®é–‹é€²åº¦ï¼š' + currentScratchPercent + '%ï¼ˆè‡³å°‘ ' + SCRATCH_CONFIRM_THRESHOLD + '% æ‰èƒ½ç¢ºèªï¼‰';

      var op = 0.18 + Math.min(0.82, currentScratchPercent/100);
      scratchNumber.style.opacity = String(op);

      btnScratchConfirm.disabled = !(currentScratchPercent >= SCRATCH_CONFIRM_THRESHOLD);
    }

    function lockCancelIfScratched(){
      if (!hasScratched){
        hasScratched = true;
        btnScratchCancel.disabled = true;
        btnScratchCancel.textContent = 'å·²åˆ®ç„¡æ³•å–æ¶ˆ';
        btnScratchClose.disabled = true;
      }
    }

    function openScratch(num){
      if (revealed[num]) return;

      currentScratchNum = num;
      currentScratchPercent = 0;
      hasScratched = false;
      lastX = null;
      lastY = null;

      scratchNumber.textContent = String(num);
      scratchNumber.style.opacity = '0.18';

      scratchOverlay.classList.add('show');
      setScratchCanvasSize();
      scratchMask();

      scratchActive = true;
      btnScratchCancel.disabled = false;
      btnScratchCancel.textContent = 'å–æ¶ˆ';
      btnScratchClose.disabled = false;
      btnScratchConfirm.disabled = true;
      scratchProg.textContent = 'åˆ®é–‹é€²åº¦ï¼š0%ï¼ˆè‡³å°‘ ' + SCRATCH_CONFIRM_THRESHOLD + '% æ‰èƒ½ç¢ºèªï¼‰';
    }

    function closeScratch(force){
      if (!force && hasScratched) return;
      scratchOverlay.classList.remove('show');
      scratchActive = false;
      currentScratchNum = null;
      currentScratchPercent = 0;
      hasScratched = false;
      lastX = null;
      lastY = null;
      sctx.globalCompositeOperation = 'source-over';
    }

    function scratchAt(clientX, clientY){
      var rect = scratchCanvas.getBoundingClientRect();
      var x = clientX - rect.left;
      var y = clientY - rect.top;

      sctx.lineCap = 'round';
      sctx.lineJoin = 'round';
      sctx.lineWidth = Math.max(18, Math.floor(scratchCanvas.width * 0.08));

      if (lastX === null){
        sctx.beginPath();
        sctx.moveTo(x, y);
        sctx.lineTo(x + 0.01, y + 0.01);
        sctx.stroke();
      } else {
        sctx.beginPath();
        sctx.moveTo(lastX, lastY);
        sctx.lineTo(x, y);
        sctx.stroke();
      }

      lastX = x;
      lastY = y;

      lockCancelIfScratched();
    }

    scratchCanvas.addEventListener('pointerdown', function(e){
      if (!scratchActive) return;
      scratchCanvas.setPointerCapture(e.pointerId);
      lastX = null;
      lastY = null;
      scratchAt(e.clientX, e.clientY);
      updateScratchProgress();
    });

    scratchCanvas.addEventListener('pointermove', function(e){
      if (!scratchActive) return;
      if ((e.buttons & 1) !== 1) return;
      scratchAt(e.clientX, e.clientY);
      updateScratchProgress();
    });

    btnScratchCancel.addEventListener('click', function(){
      if (hasScratched) return;
      closeScratch(true);
    });

    btnScratchClose.addEventListener('click', function(){
      if (hasScratched) return;
      closeScratch(true);
    });

    scratchOverlay.addEventListener('click', function(e){
      if (e.target === scratchOverlay && !hasScratched) closeScratch(true);
    });

    btnScratchConfirm.addEventListener('click', function(){
      if (currentScratchNum == null) return;
      if (currentScratchPercent < SCRATCH_CONFIRM_THRESHOLD) return;

      revealed[currentScratchNum] = 1;
      closeScratch(true);
      build();
    });

    // ===== Build board =====
    function build(){
      board.innerHTML = '';
      board.style.gridTemplateColumns = 'repeat(' + current.cols + ', var(--cellSize))';

      if (!order || order.length !== current.total) order = shuffle(current.total);

      for (var i=0;i<order.length;i++){
        (function(n){
          var c = document.createElement('div');
          var isRevealed = !!revealed[n];
          c.className = 'cell ' + (isRevealed ? 'revealed' : 'covered');
          c.textContent = String(n);

          if (isRevealed && winning[n]) c.className += ' win';

          c.addEventListener('click', function(){
            if (revealed[n]) return;
            openScratch(n);
          });

          board.appendChild(c);
        })(order[i]);
      }

      updateHeader();
      updateStats();
      renderWinList();
      fitCellSize();
      save();
    }

    // ===== Fullscreen =====
    function isFullscreen(){ return document.fullscreenElement || document.webkitFullscreenElement; }
    function toggleFullscreen(){
      if (!isFullscreen()){
        var el = document.documentElement;
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      }
    }
    btnFullscreen.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', function(){
      btnFullscreen.textContent = isFullscreen() ? 'â›¶ é€€å‡ºå…¨è¢å¹•' : 'â›¶ å…¨è¢å¹•';
      fitCellSize();
    });

    // ===== Settings modal =====
    function openSettings(){
      if (!requirePwdOnce()) return;
      settingsOverlay.classList.add('show');
    }
    function closeSettings(){ settingsOverlay.classList.remove('show'); }

    btnSettings.addEventListener('click', openSettings);
    btnCloseSettings.addEventListener('click', closeSettings);
    settingsOverlay.addEventListener('click', function(e){ if (e.target === settingsOverlay) closeSettings(); });

    // ===== Settings actions =====
    btnRandom.addEventListener('click', function(){
      var raw = prompt('è¦éš¨æ©Ÿé¸å¹¾å€‹ä¸­çè™Ÿç¢¼ï¼Ÿï¼ˆ1â€“' + current.total + 'ï¼‰', '1');
      if (raw === null) return;
      var k = parseInt(raw, 10);
      if (!isFinite(k) || k <= 0) return;

      var pool = [];
      for (var i=1;i<=current.total;i++) if (!winning[i]) pool.push(i);
      for (var j=pool.length-1;j>0;j--){
        var x = Math.floor(Math.random()*(j+1));
        var tmp = pool[j]; pool[j]=pool[x]; pool[x]=tmp;
      }

      var take = Math.min(k, pool.length);
      for (var t=0;t<take;t++) winning[pool[t]] = 1;

      build();
    });

    btnPick.addEventListener('click', function(){
      var raw = prompt('è¼¸å…¥ä¸­çè™Ÿç¢¼ï¼ˆ1â€“' + current.total + 'ï¼Œé€—è™Ÿæˆ–ç©ºç™½åˆ†éš”ï¼‰', '');
      if (raw === null) return;

      raw = raw.split(',').join(' ');
      var parts = raw.split(' ');
      for (var i=0;i<parts.length;i++){
        var s = String(parts[i] || '').trim();
        if (!s) continue;
        var n = parseInt(s, 10);
        if (isFinite(n) && n>=1 && n<=current.total) winning[n] = 1;
      }

      build();
    });

    btnReset.addEventListener('click', function(){
      var ok = confirm('ç¢ºå®šè¦æ›ç‰ˆå—ï¼Ÿ\nï¼ˆæœƒæ¸…ç©ºä¸­çè™Ÿç¢¼èˆ‡æ‰€æœ‰åˆ®é–‹ç‹€æ…‹ï¼‰');
      if (!ok) return;
      revealed = {};
      winning = {};
      order = shuffle(current.total);
      build();
    });

    btnSize.addEventListener('click', function(){
      var lines = [];
      for (var i=0;i<SIZE_PRESETS.length;i++){
        var s = SIZE_PRESETS[i];
        lines.push((i+1) + '. ' + s.total + ' æ´ï¼ˆ' + s.rows + ' æ’ x ' + s.cols + ' åˆ—ï¼‰');
      }
      var msg = 'é¸æ“‡æ´æ•¸ï¼š\n' + lines.join('\n') + '\n\nè«‹è¼¸å…¥ 1-' + SIZE_PRESETS.length + 'ï¼š';
      var raw = prompt(msg, String(SIZE_PRESETS.length));
      if (raw === null) return;
      var pick = parseInt(raw, 10);
      if (!isFinite(pick) || !SIZE_PRESETS[pick-1]) return;

      current = {
        total: SIZE_PRESETS[pick-1].total,
        rows: SIZE_PRESETS[pick-1].rows,
        cols: SIZE_PRESETS[pick-1].cols
      };
      revealed = {};
      winning = {};
      order = shuffle(current.total);
      build();
    });

    // ===== Tests =====
    (function(){
      if (SIZE_PRESETS.length !== 7) console.warn('TEST FAIL: presets count');
      for (var i=0;i<SIZE_PRESETS.length;i++){
        var p = SIZE_PRESETS[i];
        if (p.total !== p.rows*p.cols) console.warn('TEST FAIL: preset total mismatch', p);
      }
      // âœ… ç›®å‰é–€æª»æ˜¯ 10
      if (SCRATCH_CONFIRM_THRESHOLD !== 10) console.warn('TEST WARN: threshold expected 10');
      if (!board || !btnSettings || !scratchCanvas) console.warn('TEST FAIL: required DOM missing');
    })();

    // ===== Init =====
    load();
    build();

    window.addEventListener('resize', function(){
      fitCellSize();
    });
  });
  </script>
</body>
</html>

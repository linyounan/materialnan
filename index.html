<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åˆ®åˆ®å¡ï¼ˆFirebaseï¼‰</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(0,0,0,.10);
      --shadow:0 10px 24px rgba(0,0,0,.10);
      --btn:#f3f4f6;
      --btnHover:#e5e7eb;
      --primary:#2563eb;
      --danger:#ef4444;
      --win:#f59e0b;
      --covered:#000000;
      --cellSize: 40px;
      --gap: 10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{max-width:1120px;margin:22px auto;padding:0 14px}

    header{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      padding:14px 14px;
      background: var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.5}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      border:1px solid var(--border);
      background: var(--btn);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    button:hover{background: var(--btnHover)}
    button:active{transform: translateY(1px)}
    button.primary{border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.08)}
    button.primary:hover{background: rgba(37,99,235,.12)}
    button.danger{border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.08)}
    button.danger:hover{background: rgba(239,68,68,.12)}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      background: rgba(0,0,0,.02);
      font-size:13px;
      color: var(--text);
      max-width: 260px;
    }
    .chip .dot{width:8px;height:8px;border-radius:999px;background: rgba(16,185,129,.9)}
    .chip .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .layout{margin-top:14px;display:grid;grid-template-columns: 1fr;gap:14px}
    @media (min-width: 980px){
      .layout{grid-template-columns: 1.45fr .55fr}
    }

    .panel{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }
    .panelTitle{font-size:13px;color:var(--muted)}
    .stats{font-size:13px;color:var(--muted)}

    .board{
      padding:12px;
      display:grid;
      gap: var(--gap);
      justify-content: center;
      align-content: start;
    }

    .cell{
      width: var(--cellSize);
      height: var(--cellSize);
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size: calc(var(--cellSize) * 0.38);
      line-height: 1;
      border:1px solid var(--border);
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .cell.covered{
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.10), rgba(255,255,255,.03) 45%, rgba(0,0,0,.25) 72%), var(--covered);
      color: transparent;
    }
    .cell.covered:hover{filter:brightness(1.05)}
    .cell.revealed{
      background:#ffffff;
      color: var(--text);
      cursor: default;
    }
    .cell.revealed.win{
      border-color: rgba(245,158,11,.65);
      box-shadow: 0 10px 20px rgba(245,158,11,.16), 0 10px 20px rgba(0,0,0,.10);
    }

    .side{padding:12px 14px;display:grid;gap:12px}
    .box{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background: rgba(0,0,0,.02);
    }
    .box h2{margin:0 0 8px 0;font-size:13px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);line-height:1.55}

    .winList{display:flex;flex-wrap:wrap;gap:8px;min-height:28px}
    .pill{
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.02);
      color: var(--text);
    }
    .pill.hit{border-color: rgba(245,158,11,.65); background: rgba(245,158,11,.12)}

    .fullscreenOn .wrap{max-width:100%;margin:0;padding:10px}
    .fullscreenOn header{position:sticky;top:0;z-index:20}
    body.fullscreenOn{ --gap: 8px; }

    @media (max-width: 520px){
      :root{ --gap: 8px; }
      button{padding:10px 10px}
    }

    /* -------- Login Gate -------- */
    .modalOverlay{
      position:fixed;inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width: min(520px, 100%);
      background: #fff;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
    }
    .modalTitle{font-weight:700}
    .modalBody{padding: 14px}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{
      flex:1;
      padding:10px 12px;
      border-radius:12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.03);
      cursor:pointer;
      font-weight:700;
    }
    .tab.active{background: rgba(37,99,235,.10); border-color: rgba(37,99,235,.35)}

    .form{display:grid;gap:10px}
    label{font-size:12px;color:var(--muted)}
    input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 14px;
    }
    input:focus{border-color: rgba(37,99,235,.45)}

    .row{display:grid;gap:8px}
    .row2{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width: 420px){ .row2{grid-template-columns:1fr} }

    .divider{
      display:flex;align-items:center;gap:10px;
      margin: 12px 0;
      color: var(--muted);
      font-size: 12px;
    }
    .divider:before,.divider:after{
      content:"";flex:1;height:1px;background: var(--border);
    }

    .small{font-size:12px;color:var(--muted);line-height:1.55}
    .dangerText{color: var(--danger)}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-bottom-width:2px; border-radius:8px; background: rgba(0,0,0,.03)}
  </style>
</head>
<body>
  <!-- ===== Login Gate (ä¸€å®šè¦å…ˆç™»å…¥) ===== -->
  <div class="modalOverlay show" id="loginGate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="gateTitle">è«‹å…ˆç™»å…¥</div>
      </div>
      <div class="modalBody">
        <div class="tabs">
          <button class="tab active" type="button" id="gateTabLogin">ç™»å…¥</button>
          <button class="tab" type="button" id="gateTabRegister">è¨»å†Š</button>
        </div>
        <div class="row">
          <label>Email</label>
          <input id="gateEmail" type="email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div class="row">
          <label>å¯†ç¢¼</label>
          <input id="gatePass" type="password" placeholder="è‡³å°‘ 6 ç¢¼" autocomplete="current-password" />
        </div>
        <div class="row2" style="margin-top:6px;">
          <button class="primary" type="button" id="gateSubmit">ç™»å…¥</button>
          <button type="button" id="gateClear">æ¸…ç©º</button>
        </div>
        <div class="divider">æˆ–</div>
        <button class="primary" type="button" id="gateGoogle">ä½¿ç”¨ Google ç™»å…¥</button>

        <div class="small" style="margin-top:10px;">
          ä½ å·²é¸æ“‡ã€Œ<b>å¿…é ˆç™»å…¥æ‰å¯ç©</b>ã€ã€‚<br>
          è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ <span class="kbd">firebaseConfig</span>ï¼Œä¸¦åœ¨ Firebase Console é–‹å•Ÿï¼š<b>Authentication â†’ Email/Password</b> èˆ‡ <b>Google</b>ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- ===== App ===== -->
  <div class="wrap" id="app" style="display:none;">
    <header>
      <div>
        <h1 id="title">åˆ®åˆ®å¡</h1>
        <div class="sub" id="subtitle"></div>
      </div>
      <div class="controls">
        <span class="chip" id="userChip" style="display:none;">
          <span class="dot"></span><span class="name" id="userName"></span>
        </span>
        <button class="danger" id="btnLogout" type="button" style="display:none;">ğŸšª ç™»å‡º</button>

        <button class="primary" id="btnRandom" type="button">ğŸ² éš¨æ©Ÿé¸è™Ÿï¼ˆéœ€å¯†ç¢¼ï¼‰</button>
        <button class="primary" id="btnPick" type="button">ğŸ§· æŒ‡å®šé¸è™Ÿï¼ˆéœ€å¯†ç¢¼ï¼‰</button>
        <button class="primary" id="btnSize" type="button">ğŸ§© æ›´æ›æ´æ•¸ï¼ˆéœ€å¯†ç¢¼ï¼‰</button>
        <button class="danger" id="btnReset" type="button">ğŸ” æ›ç‰ˆï¼ˆéœ€å¯†ç¢¼ï¼‰</button>
        <button class="primary" id="btnFullscreen" type="button">ğŸ“± å…¨è¢å¹•ï¼šé—œ</button>
      </div>
    </header>

    <div class="layout">
      <section class="panel" id="leftPanel">
        <div class="panelHead">
          <div class="panelTitle">åˆ®å¡ç‰ˆé¢</div>
          <div class="stats" id="stats"></div>
        </div>
        <div class="board" id="board"></div>
      </section>

      <aside class="panel">
        <div class="panelHead">
          <div class="panelTitle">ä¸­çè³‡è¨Š</div>
          <div class="stats" id="winStats"></div>
        </div>
        <div class="side">
          <div class="box">
            <h2>ä¸­çè™Ÿç¢¼</h2>
            <div class="winList" id="winList"></div>
            <div class="hint" style="margin-top:10px;">
              â€¢ ä¸­çä¸è·³é€šçŸ¥ï¼ˆåªç”¨å¤–æ¡†ï¼‹å³å´æ¸…å–®ï¼‰ã€‚<br>
              â€¢ ã€Œæ›´æ›æ´æ•¸ã€æœƒæ¸…ç©ºæœ¬å±€ï¼ˆä¸­çèˆ‡åˆ®é–‹ï¼‰ã€‚<br>
              â€¢ âœ… ç™»å…¥å¾Œæœƒç”¨ Firebase åŒæ­¥ï¼ˆä¸åŒè£ç½®ä¹Ÿå¯é‚„åŸï¼‰ã€‚
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- âœ… Firebase + App Logicï¼ˆESM moduleï¼‰ -->
  <script type="module">
    // ===== 0) å…ˆå¡«ä½ çš„ Firebase è¨­å®š =====
    // Firebase Console â†’ Project settings â†’ Your apps â†’ Web app â†’ firebaseConfig
    const firebaseConfig = {
      apiKey: "",
      authDomain: "",
      projectId: "",
      storageBucket: "",
      messagingSenderId: "",
      appId: ""
    };

    // ===== 1) Firebase importsï¼ˆWeb SDK 12.7.0ï¼‰ =====
    // åƒè€ƒï¼šFirestore Quickstart çš„ Web SDK ç‰ˆæœ¬èˆ‡åˆå§‹åŒ–æ–¹å¼ã€‚îˆ€citeîˆ‚turn9view0îˆ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // Auth çš„ APIï¼ˆEmail/Passwordã€Google providerï¼‰åƒè€ƒ Firebase Auth Web æ–‡ä»¶çš„å‘¼å«æ–¹å¼ã€‚îˆ€citeîˆ‚turn6view0îˆ‚turn5view0îˆ

    // ===== 2) DOM helpers =====
    const $ = (id) => document.getElementById(id);

    const loginGate = $('loginGate');
    const gateTabLogin = $('gateTabLogin');
    const gateTabRegister = $('gateTabRegister');
    const gateEmail = $('gateEmail');
    const gatePass = $('gatePass');
    const gateSubmit = $('gateSubmit');
    const gateClear = $('gateClear');
    const gateGoogle = $('gateGoogle');

    const appEl = $('app');
    const userChip = $('userChip');
    const userName = $('userName');
    const btnLogout = $('btnLogout');

    const titleEl = $('title');
    const subtitleEl = $('subtitle');
    const boardEl = $('board');
    const statsEl = $('stats');
    const winStatsEl = $('winStats');
    const winListEl = $('winList');

    const btnRandom = $('btnRandom');
    const btnPick = $('btnPick');
    const btnSize = $('btnSize');
    const btnReset = $('btnReset');
    const btnFullscreen = $('btnFullscreen');

    // ===== 3) åŸºæœ¬è¨­å®šï¼ˆä½ çš„åŸåŠŸèƒ½ä¿ç•™ï¼‰ =====
    const PASSWORD = "1234";
    const SIZE_PRESETS = [
      { total: 20,  rows: 4,  cols: 5  },
      { total: 40,  rows: 5,  cols: 8  },
      { total: 60,  rows: 6,  cols: 10 },
      { total: 80,  rows: 8,  cols: 10 },
      { total: 100, rows: 10, cols: 10 },
      { total: 120, rows: 10, cols: 12 },
      { total: 160, rows: 10, cols: 16 },
    ];

    // ===== 4) App State =====
    let current = { total: 160, rows: 10, cols: 16 };
    const revealed = new Set();
    const winning = new Set();
    let order = [];
    let isFullscreenUI = false;

    // Firebase runtime
    let fbApp = null;
    let auth = null;
    let db = null;
    let user = null;

    // Firestore doc path: users/{uid}/scratch/state
    const stateDocRef = () => doc(db, 'users', user.uid, 'scratch', 'state');

    // ===== 5) Utils =====
    function isFirebaseConfigReady(){
      return firebaseConfig && firebaseConfig.apiKey && firebaseConfig.authDomain && firebaseConfig.projectId && firebaseConfig.appId;
    }

    function requirePassword(){
      const p = prompt('è«‹è¼¸å…¥å¯†ç¢¼ï¼š');
      if (p === null) return false;
      if (p !== PASSWORD){ alert('å¯†ç¢¼éŒ¯èª¤'); return false; }
      return true;
    }

    function clampInt(raw, min, max){
      const x = Number.parseInt(String(raw), 10);
      if (!Number.isFinite(x)) return null;
      return Math.max(min, Math.min(max, x));
    }

    function sortedArrayFromSet(set){
      return Array.from(set).sort((a,b)=>a-b);
    }

    function makeShuffledNumbers(total){
      const nums = Array.from({length: total}, (_,i)=>i+1);
      for (let i=nums.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [nums[i], nums[j]] = [nums[j], nums[i]];
      }
      return nums;
    }

    // ===== 6) UI render =====
    function updateHeader(){
      titleEl.textContent = `åˆ®åˆ®å¡ï¼ˆ1â€“${current.total}ï¼‰`;
      subtitleEl.innerHTML = `ç‰ˆé¢ï¼š<b>${current.rows} æ’ Ã— ${current.cols} åˆ—</b>ï¼ˆå…± ${current.total} æ ¼ï¼‰ã€‚æœªåˆ®é–‹ç‚ºé»‘è‰²åœ“å½¢ï¼›é»æ“Šå¾Œé¡¯ç¤ºè™Ÿç¢¼ï¼Œä¸”<b>ä¸å¯å¾©åŸ</b>ã€‚`;
    }

    function renderUserUI(){
      if (!user) {
        userChip.style.display = 'none';
        btnLogout.style.display = 'none';
        return;
      }
      userChip.style.display = '';
      btnLogout.style.display = '';
      userName.textContent = user.displayName || user.email || 'å·²ç™»å…¥';
    }

    function renderWinList(){
      const wins = sortedArrayFromSet(winning);
      winStatsEl.textContent = `ä¸­çè™Ÿç¢¼ ${wins.length} å€‹`;

      winListEl.innerHTML = '';
      if (wins.length === 0){
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.textContent = 'å°šæœªè¨­å®šä¸­çè™Ÿç¢¼';
        winListEl.appendChild(empty);
        return;
      }

      for (const n of wins){
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.textContent = String(n);
        if (revealed.has(n)) pill.classList.add('hit');
        winListEl.appendChild(pill);
      }
    }

    function updateStats(){
      statsEl.textContent = `å·²åˆ®é–‹ ${revealed.size} / ${current.total}`;
    }

    function fitBoardToViewport(){
      const rootStyles = getComputedStyle(document.documentElement);
      const gap = parseFloat(rootStyles.getPropertyValue('--gap')) || 10;

      const boardRect = boardEl.getBoundingClientRect();
      const availableW = Math.max(0, boardRect.width);

      const headerEl = document.querySelector('header');
      const headerH = headerEl ? headerEl.getBoundingClientRect().height : 0;
      const leftHead = document.querySelector('#leftPanel .panelHead') || document.querySelector('.panel .panelHead');
      const panelHeadH = leftHead ? leftHead.getBoundingClientRect().height : 0;

      const extra = 28;
      const availableH = Math.max(160, window.innerHeight - headerH - panelHeadH - extra);

      const cols = current.cols;
      const rows = current.rows;

      const sizeByW = (availableW - gap * (cols - 1)) / cols;
      const sizeByH = (availableH - gap * (rows - 1)) / rows;
      let cell = Math.floor(Math.min(sizeByW, sizeByH));
      cell = Math.max(18, Math.min(cell, 72));

      document.documentElement.style.setProperty('--cellSize', cell + 'px');
      boardEl.style.gridTemplateColumns = `repeat(${cols}, var(--cellSize))`;
    }

    // ===== 7) Firestore sync =====
    function stateToJson(){
      return {
        version: 1,
        current,
        order,
        revealed: Array.from(revealed),
        winning: Array.from(winning),
        isFullscreenUI,
        updatedAt: serverTimestamp()
      };
    }

    function applyStateFromJson(s){
      // defensive
      if (!s || typeof s !== 'object') return false;

      if (s.current && typeof s.current === 'object') {
        const t = Number(s.current.total);
        const r = Number(s.current.rows);
        const c = Number(s.current.cols);
        const preset = SIZE_PRESETS.find(p => p.total===t && p.rows===r && p.cols===c);
        if (preset) current = { ...preset };
      }

      revealed.clear();
      winning.clear();

      if (Array.isArray(s.revealed)) s.revealed.forEach(n => { const x = Number(n); if (Number.isFinite(x)) revealed.add(x); });
      if (Array.isArray(s.winning)) s.winning.forEach(n => { const x = Number(n); if (Number.isFinite(x)) winning.add(x); });
      if (Array.isArray(s.order)) order = s.order.map(n => Number(n)).filter(Number.isFinite);
      if (typeof s.isFullscreenUI === 'boolean') isFullscreenUI = s.isFullscreenUI;

      // ä¿®æ­£
      if (!Array.isArray(order) || order.length !== current.total) order = makeShuffledNumbers(current.total);
      for (const n of Array.from(revealed)) if (n < 1 || n > current.total) revealed.delete(n);
      for (const n of Array.from(winning)) if (n < 1 || n > current.total) winning.delete(n);

      return true;
    }

    let saveTimer = null;
    function scheduleSave(){
      if (!user || !db) return;
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          await setDoc(stateDocRef(), stateToJson(), { merge: true });
        } catch (e) {
          console.warn('save failed', e);
        }
      }, 250);
    }

    async function loadStateFromFirestore(){
      try {
        const snap = await getDoc(stateDocRef());
        if (!snap.exists()) {
          // ç¬¬ä¸€æ¬¡ç™»å…¥ï¼šå»ºç«‹ä¸€ä»½åˆå§‹ç›¤é¢ï¼ˆäº‚ç¢¼å›ºå®šï¼‰
          order = makeShuffledNumbers(current.total);
          await setDoc(stateDocRef(), stateToJson(), { merge: true });
          return;
        }
        const data = snap.data();
        const ok = applyStateFromJson(data);
        if (!ok) {
          // fallback
          order = makeShuffledNumbers(current.total);
        }
      } catch (e) {
        console.warn('load failed', e);
        // fallback
        order = makeShuffledNumbers(current.total);
      }
    }

    // ===== 8) Build board =====
    function buildBoard(){
      boardEl.innerHTML = '';
      if (!Array.isArray(order) || order.length !== current.total) {
        order = makeShuffledNumbers(current.total);
      }
      boardEl.style.gridTemplateColumns = `repeat(${current.cols}, var(--cellSize))`;

      for (const num of order){
        const cell = document.createElement('button');
        cell.type = 'button';
        cell.className = 'cell';
        cell.dataset.num = String(num);
        cell.textContent = String(num);

        if (!revealed.has(num)) {
          cell.classList.add('covered');
        } else {
          cell.classList.add('revealed');
          if (winning.has(num)) cell.classList.add('win');
        }

        cell.addEventListener('click', () => {
          const n = Number(cell.dataset.num);
          if (revealed.has(n)) return;

          revealed.add(n);
          cell.classList.remove('covered');
          cell.classList.add('revealed');
          if (winning.has(n)) cell.classList.add('win');

          updateStats();
          renderWinList();
          scheduleSave();
        });

        boardEl.appendChild(cell);
      }

      document.body.classList.toggle('fullscreenOn', isFullscreenUI);
      btnFullscreen.textContent = `ğŸ“± å…¨è¢å¹•ï¼š${isFullscreenUI ? 'é–‹' : 'é—œ'}`;

      updateHeader();
      updateStats();
      renderWinList();
      fitBoardToViewport();
    }

    function refreshWinningHighlights(){
      for (const node of boardEl.querySelectorAll('.cell')){
        const n = Number(node.dataset.num);
        if (!revealed.has(n)) continue;
        if (winning.has(n)) node.classList.add('win');
        else node.classList.remove('win');
      }
      renderWinList();
      scheduleSave();
    }

    // ===== 9) Button actions =====
    function pickRandomWinners(){
      if (!requirePassword()) return;
      const raw = prompt(`è¦éš¨æ©Ÿé¸å¹¾å€‹ä¸­çè™Ÿç¢¼ï¼Ÿï¼ˆ1â€“${current.total}ï¼‰`, '1');
      if (raw === null) return;
      const count = clampInt(raw, 1, current.total);
      if (count === null) { alert('è«‹è¼¸å…¥æ•¸å­—'); return; }

      const pool = [];
      for (let i=1;i<=current.total;i++) if (!winning.has(i)) pool.push(i);
      if (pool.length === 0) { alert(`ç›®å‰ 1â€“${current.total} å·²å…¨éƒ¨è¨­ç‚ºä¸­çè™Ÿç¢¼äº†`); return; }

      for (let i=pool.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }

      const k = Math.min(count, pool.length);
      for (let i=0;i<k;i++) winning.add(pool[i]);
      refreshWinningHighlights();
    }

    function pickSpecificWinners(){
      if (!requirePassword()) return;
      const raw = prompt(`è¼¸å…¥è¦æŒ‡å®šçš„ä¸­çè™Ÿç¢¼ï¼ˆ1â€“${current.total}ï¼Œå¯ç”¨é€—è™Ÿæˆ–ç©ºç™½åˆ†éš”ï¼‰
ä¾‹å¦‚ï¼š1, 16, 88`, '');
      if (raw === null) return;

      const parts = raw.replaceAll(',', ' ').split(' ').map(s=>s.trim()).filter(Boolean);
      if (!parts.length) { alert('æ²’æœ‰è®€åˆ°ä»»ä½•è™Ÿç¢¼'); return; }

      const nums = parts.map(s=>Number.parseInt(s,10)).filter(Number.isFinite);
      if (!nums.length) { alert('æ²’æœ‰è®€åˆ°ä»»ä½•æœ‰æ•ˆæ•¸å­—'); return; }

      const bad = nums.filter(n=>n<1 || n>current.total);
      if (bad.length) { alert(`ä»¥ä¸‹è™Ÿç¢¼è¶…å‡ºç¯„åœï¼ˆ1â€“${current.total}ï¼‰ï¼š${bad.join(', ')}`); return; }

      for (const n of nums) winning.add(n);
      refreshWinningHighlights();
    }

    function resetBoard(){
      if (!requirePassword()) return;
      const ok = confirm('ç¢ºå®šè¦æ›ç‰ˆå—ï¼Ÿ
ï¼ˆæœƒæ¸…ç©ºä¸­çè™Ÿç¢¼èˆ‡æ‰€æœ‰åˆ®é–‹ç‹€æ…‹ï¼‰');
      if (!ok) return;
      revealed.clear();
      winning.clear();
      order = makeShuffledNumbers(current.total);
      buildBoard();
      scheduleSave();
    }

    function changeSize(){
      if (!requirePassword()) return;
      const lines = SIZE_PRESETS.map((s, idx)=>`${idx+1}. ${s.total} æ´ï¼ˆ${s.rows} æ’ x ${s.cols} åˆ—ï¼‰`).join('
');
      const raw = prompt(`é¸æ“‡æ´æ•¸ï¼š
${lines}

è«‹è¼¸å…¥ 1-${SIZE_PRESETS.length}ï¼š`, String(SIZE_PRESETS.length));
      if (raw === null) return;
      const pick = clampInt(raw, 1, SIZE_PRESETS.length);
      if (pick === null) { alert('è«‹è¼¸å…¥æ•¸å­—'); return; }

      current = { ...SIZE_PRESETS[pick-1] };
      revealed.clear();
      winning.clear();
      order = makeShuffledNumbers(current.total);
      buildBoard();
      scheduleSave();
    }

    async function toggleFullscreen(){
      isFullscreenUI = !isFullscreenUI;
      document.body.classList.toggle('fullscreenOn', isFullscreenUI);
      btnFullscreen.textContent = `ğŸ“± å…¨è¢å¹•ï¼š${isFullscreenUI ? 'é–‹' : 'é—œ'}`;
      fitBoardToViewport();
      scheduleSave();

      try{
        if (isFullscreenUI && document.documentElement.requestFullscreen) {
          await document.documentElement.requestFullscreen();
        }
        if (!isFullscreenUI && document.fullscreenElement) {
          await document.exitFullscreen();
        }
      } catch {}
    }

    // ===== 10) Login Gate actions =====
    let gateMode = 'login';
    function setGateMode(mode){
      gateMode = mode;
      const isLogin = mode === 'login';
      gateTabLogin.classList.toggle('active', isLogin);
      gateTabRegister.classList.toggle('active', !isLogin);
      gateSubmit.textContent = isLogin ? 'ç™»å…¥' : 'è¨»å†Š';
      gatePass.autocomplete = isLogin ? 'current-password' : 'new-password';
    }

    async function emailAuthSubmit(){
      const email = (gateEmail.value || '').trim().toLowerCase();
      const pass = gatePass.value || '';
      if (!email || !email.includes('@')) { alert('è«‹è¼¸å…¥æœ‰æ•ˆ Email'); return; }
      if (pass.length < 6) { alert('å¯†ç¢¼è‡³å°‘ 6 ç¢¼'); return; }

      try{
        if (gateMode === 'register') {
          await createUserWithEmailAndPassword(auth, email, pass);
        } else {
          await signInWithEmailAndPassword(auth, email, pass);
        }
      } catch (e) {
        alert('ç™»å…¥/è¨»å†Šå¤±æ•—ï¼š' + (e?.message || 'unknown'));
      }
    }

    async function googleAuth(){
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (e) {
        alert('Google ç™»å…¥å¤±æ•—ï¼š' + (e?.message || 'unknown'));
      }
    }

    async function doLogout(){
      try{
        await signOut(auth);
      } catch (e) {
        alert('ç™»å‡ºå¤±æ•—ï¼š' + (e?.message || 'unknown'));
      }
    }

    // ===== 11) Boot =====
    function showGate(){
      loginGate.classList.add('show');
      appEl.style.display = 'none';
    }
    function showApp(){
      loginGate.classList.remove('show');
      appEl.style.display = '';
    }

    function runSelfTests(){
      const assert = (cond, msg) => { if (!cond) console.warn('TEST FAIL:', msg); };
      assert(SIZE_PRESETS.some(p=>p.total===160), 'SIZE_PRESETS should include 160');
      assert(current.total === current.rows * current.cols, 'current total should equal rows*cols');
    }

    function bindEvents(){
      gateTabLogin.addEventListener('click', ()=>setGateMode('login'));
      gateTabRegister.addEventListener('click', ()=>setGateMode('register'));
      gateSubmit.addEventListener('click', emailAuthSubmit);
      gateGoogle.addEventListener('click', googleAuth);
      gateClear.addEventListener('click', ()=>{ gateEmail.value=''; gatePass.value=''; gateEmail.focus(); });

      btnLogout.addEventListener('click', doLogout);
      btnRandom.addEventListener('click', pickRandomWinners);
      btnPick.addEventListener('click', pickSpecificWinners);
      btnSize.addEventListener('click', changeSize);
      btnReset.addEventListener('click', resetBoard);
      btnFullscreen.addEventListener('click', toggleFullscreen);

      window.addEventListener('resize', ()=>fitBoardToViewport());
      document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement && isFullscreenUI) {
          isFullscreenUI = false;
          document.body.classList.remove('fullscreenOn');
          btnFullscreen.textContent = 'ğŸ“± å…¨è¢å¹•ï¼šé—œ';
          fitBoardToViewport();
          scheduleSave();
        }
      });

      window.addEventListener('error', (e) => {
        alert('âš ï¸ ç¨‹å¼éŒ¯èª¤ï¼š' + (e?.message || 'unknown') + '
å»ºè­°æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…· Console çœ‹è©³ç´°éŒ¯èª¤ã€‚');
      });
    }

    async function init(){
      setGateMode('login');
      bindEvents();

      if (!isFirebaseConfigReady()) {
        showGate();
        alert('ä½ å°šæœªå¡«å…¥ firebaseConfigï¼Œè«‹å…ˆå¡«å…¥å¾Œå†æ¸¬è©¦ã€‚');
        return;
      }

      fbApp = initializeApp(firebaseConfig);
      auth = getAuth(fbApp);
      db = getFirestore(fbApp);

      onAuthStateChanged(auth, async (u) => {
        user = u;
        if (!user) {
          showGate();
          renderUserUI();
          return;
        }

        // å·²ç™»å…¥ â†’ è¼‰å…¥è³‡æ–™ â†’ é¡¯ç¤ºåˆ®å¡
        renderUserUI();
        showApp();

        await loadStateFromFirestore();
        runSelfTests();
        buildBoard();
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>

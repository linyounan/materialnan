<!DOCTYPE html>
<html lang="zh-Hant">
<head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-65GTWZKRV5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-65GTWZKRV5');
</script>
  <meta charset="UTF-8">
  <title>å¨ƒå¨ƒæ©Ÿæ¸…å–®ï¼ˆå°ˆæ¥­ç‰ˆï¼‰</title>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: #f4f6f8; }
    header { background: #2c3e50; color: white; padding: 15px 20px; font-size: 20px; }

    /* ç™»éŒ„é é¢ */
    .auth-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #3498db, #8e44ad);
    }
    .auth-card {
      background: white;
      padding: 40px 35px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 380px;
      text-align: center;
      animation: fadeIn 0.6s ease;
    }
    .auth-card h2 { margin-bottom: 10px; color: #2c3e50; font-size: 22px; }
    .subtitle { margin-bottom: 20px; color: #7f8c8d; font-size: 14px; }
    .auth-card input {
      width: 100%; padding: 12px; margin: 10px 0;
      border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
    }
    .auth-card button {
      width: 100%; padding: 12px; margin: 8px 0;
      border: none; border-radius: 8px; font-size: 15px;
      cursor: pointer; transition: 0.3s;
    }
    .btn-primary { background: #3498db; color: white; }
    .btn-primary:hover { background: #2980b9; }
    .btn-secondary { background: #2ecc71; color: white; }
    .btn-secondary:hover { background: #27ae60; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }
    .btn-success { background: #2ecc71; color: white; }
    .btn-success:hover { background: #27ae60; }
    .auth-message { margin-top: 15px; font-size: 14px; color: red; }

    /* ä¸»ä»‹é¢ */
    .app-wrapper { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .app-header h2 { color: #2c3e50; }
    .app-card {
      background: white; padding: 20px; margin-bottom: 20px;
      border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      animation: fadeIn 0.6s ease;
    }
    .app-card h3 { margin-bottom: 15px; color: #34495e; font-size: 18px; }
    #map {
      width: 100%; height: 400px;
      border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f9fafb; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>å¨ƒå¨ƒæ©Ÿæ¸…å–®ç®¡ç†</header>

  <!-- ç™»éŒ„å€ -->
  <div class="auth-wrapper" id="authSection">
    <div class="auth-card">
      <h2>ğŸ® å¨ƒå¨ƒæ©Ÿåœ°åœ– App</h2>
      <p class="subtitle">è«‹ç™»å…¥ä»¥ç®¡ç†æ‚¨çš„æ¸…å–®</p>
      <input type="email" id="email" placeholder="é›»å­éƒµä»¶">
      <input type="password" id="password" placeholder="å¯†ç¢¼">
      <button class="btn-primary" onclick="login()">ç™»å…¥</button>
      <button class="btn-secondary" onclick="register()">è¨»å†Šæ–°å¸³è™Ÿ</button>
      <p id="authMessage" class="auth-message"></p>
    </div>
  </div>

  <!-- ä¸»åŠŸèƒ½å€ -->
  <div class="app-wrapper" id="appSection" style="display:none;">
    <div class="app-header">
      <h2 id="welcomeText">æ­¡è¿ï¼</h2>
      <button class="btn-danger" onclick="logout()">ç™»å‡º</button>
    </div>

    <div class="app-card">
      <h3>â• æ–°å¢åº—å®¶</h3>
      <input type="text" id="storeName" placeholder="è«‹è¼¸å…¥åº—å">
      <input type="text" id="storeAddr" placeholder="è«‹è¼¸å…¥åœ°å€">
      <button class="btn-primary" onclick="addRecord()">å„²å­˜</button>
      <button class="btn-success" onclick="exportData()">åŒ¯å‡º JSON</button>
    </div>

    <div class="app-card">
      <h3>ğŸ“‹ æˆ‘çš„æ¸…å–®</h3>
      <table id="dataTable">
        <thead>
          <tr>
            <th>åº—å</th>
            <th>åœ°å€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="app-card">
      <h3>ğŸ—ºï¸ åœ°åœ–</h3>
      <div id="map"></div>
    </div>
  </div>

  <!-- Firebase + Google Maps -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

    // âœ… Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB1SOrDItdUUshN2DuijWjdEAbuNXGvY6A",
      authDomain: "clawmachine-68199.firebaseapp.com",
      projectId: "clawmachine-68199",
      storageBucket: "clawmachine-68199.appspot.com",
      messagingSenderId: "416551705279",
      appId: "1:416551705279:web:3ba72ebcc992da5f78440a",
      measurementId: "G-NG3HXDQWCW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // âœ… Google Maps API Key
    const GOOGLE_API_KEY = "AIzaSyBH1BUgJopBHGDpvU6f9vGEE7U5DFeF8N4";

    let records = [];
    let map;
    let markers = [];

    // ================= èªè­‰ =================
    window.register = async function() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        document.getElementById("authMessage").textContent = "âœ… è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥";
      } catch (e) {
        document.getElementById("authMessage").textContent = "âŒ è¨»å†Šå¤±æ•—ï¼š" + e.code;
      }
    };

    window.login = async function() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        document.getElementById("authMessage").textContent = "âŒ ç™»å…¥å¤±æ•—ï¼š" + e.code;
      }
    };

    window.logout = async function() {
      await signOut(auth);
      alert("å·²ç™»å‡º");
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("authSection").style.display = "none";
        document.getElementById("appSection").style.display = "block";
        document.getElementById("welcomeText").innerText = `æ­¡è¿å›ä¾†ï¼Œ${user.email}`;
        loadFromLocal();
      } else {
        document.getElementById("authSection").style.display = "flex";
        document.getElementById("appSection").style.display = "none";
      }
    });

    // ================= æœ¬åœ°æ¸…å–®åŠŸèƒ½ =================
    async function addRecord() {
      const storeName = document.getElementById("storeName").value.trim();
      const storeAddr = document.getElementById("storeAddr").value.trim();
      if (!storeName || !storeAddr) return alert("è«‹è¼¸å…¥åº—åèˆ‡åœ°å€ï¼");

      const { lng, lat } = await getCoordinates(storeAddr);
      const record = { id: Date.now(), storeName, storeAddr, lng, lat };
      records.push(record);
      saveToLocal();
      updateTable();
      updateMap();

      document.getElementById("storeName").value = "";
      document.getElementById("storeAddr").value = "";
    }

    function updateTable() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      records.forEach(r => {
        tbody.innerHTML += `
          <tr>
            <td>${r.storeName}</td>
            <td>${r.storeAddr}</td>
            <td><button class="btn-danger" onclick="deleteRecord(${r.id})">åˆªé™¤</button></td>
          </tr>`;
      });
    }

    function deleteRecord(id) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
      records = records.filter(r => r.id !== id);
      saveToLocal();
      updateTable();
      updateMap();
    }

    function saveToLocal() {
      const user = auth.currentUser;
      if (user) {
        localStorage.setItem("clawStores_" + user.uid, JSON.stringify(records));
      }
    }

    function loadFromLocal() {
      const user = auth.currentUser;
      if (user) {
        const saved = localStorage.getItem("clawStores_" + user.uid);
        records = saved ? JSON.parse(saved) : [];
        updateTable();
        updateMap();
      }
    }

    function exportData() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(records, null, 2));
      const dlAnchor = document.createElement("a");
      dlAnchor.setAttribute("href", dataStr);
      dlAnchor.setAttribute("download", "clawStores.json");
      dlAnchor.click();
    }

    // ================= Google Maps =================
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 22.6273, lng: 120.3014 },
        zoom: 12
      });
    }

    function updateMap() {
      if (!map) return;
      markers.forEach(m => m.setMap(null));
      markers = [];
      records.forEach(r => {
        if (r.lat && r.lng) {
          const marker = new google.maps.Marker({
            position: { lat: parseFloat(r.lat), lng: parseFloat(r.lng) },
            map,
            title: r.storeName
          });
          const info = new google.maps.InfoWindow({
            content: `<b>${r.storeName}</b><br>${r.storeAddr}`
          });
          marker.addListener("click", () => info.open(map, marker));
          markers.push(marker);
        }
      });
    }

    async function getCoordinates(address) {
      try {
        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${GOOGLE_API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.status === "OK") {
          const location = data.results[0].geometry.location;
          return { lng: location.lng, lat: location.lat };
        } else {
          alert("Geocoding å¤±æ•—ï¼š" + data.status);
          return { lng: 0, lat: 0 };
        }
      } catch (err) {
        console.error("Geocoding éŒ¯èª¤ï¼š", err);
        return { lng: 0, lat: 0 };
      }
    }

    window.initMap = initMap;
  </script>

  <!-- Google Maps SDK -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBH1BUgJopBHGDpvU6f9vGEE7U5DFeF8N4&callback=initMap"></script>
</body>
</html>
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åˆ®åˆ®å¡</title>
  <style>
    :root{
      --bg:#ffffff;--text:#111827;--muted:#6b7280;--border:rgba(0,0,0,.12);
      --shadow:0 10px 24px rgba(0,0,0,.10);--btn:#f3f4f6;--btnHover:#e5e7eb;
      --primary:#2563eb;--danger:#ef4444;--win:#f59e0b;--covered:#000000;
      --cellSize:40px;--gap:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--text);
      user-select:none;-webkit-user-select:none;-ms-user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .wrap{max-width:1120px;margin:18px auto;padding:0 14px}
    header{display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap;align-items:center;padding:14px;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    h1{margin:0;font-size:18px;display:flex;flex-wrap:wrap;gap:8px;align-items:baseline}
    .meta{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{border:1px solid var(--border);background:var(--btn);padding:10px 12px;border-radius:12px;cursor:pointer}
    button:hover{background:var(--btnHover)}
    button.primary{background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.30)}
    button.danger{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.30)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .panel{margin-top:12px;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .panelHead{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .label,.stats{font-size:13px;color:var(--muted)}

    .board{padding:12px;display:grid;gap:var(--gap);justify-content:center;min-height:60vh}
    .cell{width:var(--cellSize);height:var(--cellSize);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:calc(var(--cellSize)*.34);border:1px solid var(--border);cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.12)}
    .cell.covered{background:var(--covered);color:transparent}
    .cell.revealed{background:#fff;color:var(--text);cursor:default}
    .cell.revealed.win{border-color:var(--win);box-shadow:0 10px 20px rgba(245,158,11,.16),0 10px 20px rgba(0,0,0,.10)}

    .modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modalOverlay.show{display:flex}
    .modal{width:min(560px,100%);background:#fff;border-radius:16px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden}
    .modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)}
    .modalTitle{font-weight:700}
    .modalBody{padding:14px;display:grid;gap:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.grid{grid-template-columns:1fr}}

    .scratchWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .scratchStage{position:relative;width:min(360px,84vw);aspect-ratio:1/1}
    .scratchNumber{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;color:#111;z-index:0;opacity:.18}
    .scratchCanvas{position:absolute;inset:0;z-index:2;border-radius:50%;touch-action:none;background:transparent}
    .scratchProg{font-size:12px;color:var(--muted)}

    .err{position:fixed;left:10px;right:10px;bottom:10px;background:#111;color:#fff;padding:10px 12px;border-radius:12px;font-size:12px;display:none;z-index:2000;white-space:pre-wrap}
    .err.show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="title">åˆ®åˆ®å¡ï¼ˆ1â€“160ï¼‰</h1>
      <div class="controls">
        <button id="btnFullscreen" type="button">â›¶ å…¨è¢å¹•</button>
        <button class="primary" id="btnSettings" type="button">âš™ï¸ è¨­å®š</button>
      </div>
    </header>

    <section class="panel" id="panel">
      <div class="panelHead">
        <div class="label">åˆ®å¡ç‰ˆé¢ <span class="stats" id="stats">å·²åˆ® 0 / 160</span></div>
        <div class="stats" id="winStats">ä¸­ç 0 å€‹</div>
      </div>
      <div class="board" id="board"></div>
    </section>
  </div>

  <!-- è¨­å®šè¦–çª—ï¼ˆå«ï¼šæ›ç‰ˆï¼‰ -->
  <div class="modalOverlay" id="settingsOverlay" role="dialog" aria-modal="true" aria-label="è¨­å®š">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">è¨­å®š</div>
        <button id="btnCloseSettings" type="button">âœ–</button>
      </div>
      <div class="modalBody">
        <div class="grid">
          <button class="primary" id="btnRandom" type="button">ğŸ² éš¨æ©Ÿé¸è™Ÿï¼ˆè¨­å®šä¸­çï¼‰</button>
          <button class="primary" id="btnPick" type="button">ğŸ§· æŒ‡å®šé¸è™Ÿï¼ˆè¨­å®šä¸­çï¼‰</button>
          <button class="primary" id="btnSize" type="button">ğŸ§© æ›´æ›æ´æ•¸ï¼ˆæ¸…ç©ºï¼‰</button>
          <button class="danger" id="btnReset" type="button">ğŸ” æ›ç‰ˆï¼ˆæ¸…ç©ºï¼‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ®å¡æ”¾å¤§è¦–çª— -->
  <div class="modalOverlay" id="scratchOverlay" role="dialog" aria-modal="true" aria-label="åˆ®é–‹">
    <div class="modal" style="max-width:540px">
      <div class="modalHead">
        <div class="modalTitle">åˆ®é–‹</div>
        <button id="btnScratchClose" type="button">âœ–</button>
      </div>
      <div class="modalBody">
        <div class="scratchWrap">
          <div class="scratchStage" id="scratchStage">
            <div class="scratchNumber" id="scratchNumber"></div>
            <canvas class="scratchCanvas" id="scratchCanvas" width="300" height="300"></canvas>
          </div>
          <div class="scratchProg" id="scratchProg">åˆ®é–‹é€²åº¦ï¼š0%</div>
          <div class="grid" style="width:100%">
            <button id="btnScratchCancel" type="button">å–æ¶ˆ</button>
            <button class="primary" id="btnScratchConfirm" type="button" disabled>ç¢ºèªåˆ®é–‹</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="err" id="errBox"></div>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // ===== é˜²æ­¢è¤‡è£½/å³éµï¼ˆæ³¨æ„ï¼šç„¡æ³• 100% é˜²æ­¢ï¼Œä½†å¯é™ä½ï¼‰ =====
    document.addEventListener('contextmenu', function(e){ e.preventDefault(); });
    document.addEventListener('copy', function(e){ e.preventDefault(); });
    document.addEventListener('cut', function(e){ e.preventDefault(); });
    document.addEventListener('selectstart', function(e){ e.preventDefault(); });
    document.addEventListener('keydown', function(e){
      var k = (e.key || '').toLowerCase();
      if ((e.ctrlKey || e.metaKey) && (k === 'c' || k === 'x' || k === 'a' || k === 's' || k === 'p')) e.preventDefault();
    });

    // ===== åŸºæœ¬è¨­å®š =====
    var PASSWORD = '1234';
    var EMAIL_TO = 'ian911021ian@gmail.com'; // æ›ç‰ˆå¾Œå¯„å‡ºã€Œç­”æ¡ˆã€è‰ç¨¿ï¼ˆmailtoï¼Œéœ€è¦ä½ æ‰‹å‹•æŒ‰é€å‡ºï¼‰
    var STORAGE_KEY = 'scratchcard_state_v11';
    var ROUND_KEY = 'scratchcard_round_v11';
    var SCRATCH_CONFIRM_THRESHOLD = 10; // %

    var SIZE_PRESETS = [
      {total:20,rows:4,cols:5},
      {total:40,rows:5,cols:8},
      {total:60,rows:6,cols:10},
      {total:80,rows:8,cols:10},
      {total:100,rows:10,cols:10},
      {total:120,rows:10,cols:12},
      {total:160,rows:10,cols:16}
    ];

    // ===== DOM =====
    function $(id){ return document.getElementById(id); }
    var board = $('board');
    var stats = $('stats');
    var winStats = $('winStats');
    var titleEl = $('title');

    var btnFullscreen = $('btnFullscreen');
    var btnSettings = $('btnSettings');

    var settingsOverlay = $('settingsOverlay');
    var btnCloseSettings = $('btnCloseSettings');
    var btnRandom = $('btnRandom');
    var btnPick = $('btnPick');
    var btnSize = $('btnSize');
    var btnReset = $('btnReset');

    var scratchOverlay = $('scratchOverlay');
    var scratchStage = $('scratchStage');
    var scratchNumber = $('scratchNumber');
    var scratchCanvas = $('scratchCanvas');
    var scratchProg = $('scratchProg');
    var btnScratchCancel = $('btnScratchCancel');
    var btnScratchConfirm = $('btnScratchConfirm');
    var btnScratchClose = $('btnScratchClose');

    var errBox = $('errBox');
    function showErr(msg){ errBox.textContent = 'âš ï¸ ' + msg; errBox.className = 'err show'; }
    window.addEventListener('error', function(e){ showErr((e && e.message) ? e.message : 'unknown error'); });

    if (!board || !scratchCanvas || !btnSettings) {
      showErr('DOM å…ƒä»¶ç¼ºå¤±ï¼Œè«‹ç¢ºèªæ•´ä»½æª”æ¡ˆå®Œæ•´è²¼ä¸Š');
      return;
    }

    // ===== State =====
    var current = {total:160,rows:10,cols:16};
    var order = [];
    var revealed = {}; // num -> 1
    var winning = {};  // num -> 1
    var roundId = 1;

    // ===== Utils =====
    function safeParse(raw){ try { return JSON.parse(raw); } catch(e){ return null; } }

    function shuffleNums(total){
      var arr = [];
      for (var i=1;i<=total;i++) arr.push(i);
      for (var j=arr.length-1;j>0;j--){
        var x = Math.floor(Math.random()*(j+1));
        var tmp = arr[j]; arr[j]=arr[x]; arr[x]=tmp;
      }
      return arr;
    }

    function sortedKeys(obj){
      var keys = [];
      for (var k in obj) keys.push(+k);
      keys.sort(function(a,b){ return a-b; });
      return keys;
    }

    function bumpRound(){
      roundId = Date.now();
      try{ localStorage.setItem(ROUND_KEY, String(roundId)); }catch(e){}
    }

    // ===== Email draft (æ–¹æ¡ˆAï¼šé–‹å•Ÿéƒµä»¶è‰ç¨¿) =====
    function buildAnswerText(){
      var lines = [];
      lines.push('åˆ®åˆ®å¡ç­”æ¡ˆ');
      lines.push('åºè™Ÿï¼š#' + roundId);
      lines.push('æ´æ•¸ï¼š' + current.total + 'ï¼ˆ' + current.rows + 'Ã—' + current.cols + 'ï¼‰');
      lines.push('æ™‚é–“ï¼š' + new Date(roundId).toLocaleString());
      lines.push('');
      lines.push('ã€æ ¼å­æ’åˆ—ã€‘');
      for (var r=0; r<current.rows; r++){
        var row = [];
        for (var c=0; c<current.cols; c++){
          var idx = r*current.cols + c;
          row.push(String(order[idx]).padStart(3,' '));
        }
        lines.push(row.join(' '));
      }
      lines.push('');
      lines.push('ã€é€—è™Ÿæ¸…å–®ã€‘');
      lines.push(order.join(','));
      // âœ… é‡è¦ï¼šä¸è¦æŠŠçœŸæ­£çš„æ›è¡Œå¡é€²å¼•è™Ÿè£¡ï¼Œé¿å…èªæ³•ä¸­æ–·
      return lines.join('\n');
    }

    function openMailDraft(){
      if (!EMAIL_TO) return;
      var subject = 'åˆ®åˆ®å¡ç­”æ¡ˆ #' + roundId + 'ï¼ˆ' + current.total + 'ï¼‰';
      var body = buildAnswerText();
      var url = 'mailto:' + encodeURIComponent(EMAIL_TO)
        + '?subject=' + encodeURIComponent(subject)
        + '&body=' + encodeURIComponent(body);
      window.location.href = url;
    }

    function save(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          current: current,
          order: order,
          revealed: Object.keys(revealed),
          winning: Object.keys(winning)
        }));
      }catch(e){}
    }

    function load(){
      try{
        var rid = localStorage.getItem(ROUND_KEY);
        roundId = rid ? (parseInt(rid,10) || 1) : 1;
      }catch(e){ roundId = 1; }

      var raw = null;
      try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){ raw = null; }
      if (!raw) return;

      var s = safeParse(raw);
      if (!s || typeof s !== 'object') return;

      if (s.current && typeof s.current === 'object'){
        var t = Number(s.current.total), r = Number(s.current.rows), c = Number(s.current.cols);
        for (var i=0;i<SIZE_PRESETS.length;i++){
          var p = SIZE_PRESETS[i];
          if (p.total===t && p.rows===r && p.cols===c){ current = {total:p.total,rows:p.rows,cols:p.cols}; break; }
        }
      }

      if (Array.isArray(s.order)){
        order = [];
        for (var j=0;j<s.order.length;j++){
          var n = Number(s.order[j]);
          if (isFinite(n)) order.push(n);
        }
      }

      revealed = {};
      winning = {};

      if (Array.isArray(s.revealed)) s.revealed.forEach(function(n){ revealed[Number(n)] = 1; });
      if (Array.isArray(s.winning)) s.winning.forEach(function(n){ winning[Number(n)] = 1; });

      if (!order || order.length !== current.total) order = [];
    }

    function requirePwd(){
      var p = prompt('è«‹è¼¸å…¥å¯†ç¢¼');
      if (p === null) return false;
      if (p !== PASSWORD){ alert('å¯†ç¢¼éŒ¯èª¤'); return false; }
      return true;
    }

    // ===== Layout sizing =====
    function fitCellSize(){
      var gap = 10;
      var bw = board.getBoundingClientRect().width;
      var bh = Math.max(240, window.innerHeight - 220);

      var cw = (bw - gap*(current.cols-1)) / current.cols;
      var ch = (bh - gap*(current.rows-1)) / current.rows;
      var cell = Math.floor(Math.min(cw, ch));
      if (!isFinite(cell)) cell = 40;
      cell = Math.max(18, Math.min(72, cell));

      document.documentElement.style.setProperty('--cellSize', cell + 'px');
      board.style.gridTemplateColumns = 'repeat(' + current.cols + ', var(--cellSize))';
    }

    // ===== Header render =====
    function renderTitle(){
      var wins = sortedKeys(winning);
      var winText = wins.length ? ('ï½œä¸­çï¼š' + wins.join(', ')) : '';
      titleEl.innerHTML = 'åˆ®åˆ®å¡ï¼ˆ1â€“' + current.total + 'ï¼‰ <span class="meta">ï½œ#' + roundId + winText + '</span>';
    }

    function updateStats(){
      var c = 0;
      for (var k in revealed) c++;
      stats.textContent = 'å·²åˆ® ' + c + ' / ' + current.total;
      winStats.textContent = 'ä¸­ç ' + sortedKeys(winning).length + ' å€‹';
    }

    // ===== Scratch modal =====
    var sctx = scratchCanvas.getContext('2d');
    var scratchActive = false;
    var curNum = null;
    var hasScratched = false;
    var lastX = null;
    var lastY = null;

    function setScratchCanvasSize(){
      var r = scratchStage.getBoundingClientRect();
      var s = Math.max(220, Math.floor(Math.min(r.width, r.height)));
      scratchCanvas.width = s;
      scratchCanvas.height = s;
      scratchNumber.style.fontSize = Math.floor(s * 0.26) + 'px';
    }

    function scratchMask(){
      var w = scratchCanvas.width, h = scratchCanvas.height;
      sctx.globalCompositeOperation = 'source-over';
      sctx.clearRect(0,0,w,h);
      sctx.fillStyle = '#000';
      sctx.beginPath();
      sctx.arc(w/2, h/2, Math.min(w,h)/2, 0, Math.PI*2);
      sctx.fill();
      sctx.globalCompositeOperation = 'destination-out';
    }

    function getScratchPercent(){
      var w = scratchCanvas.width, h = scratchCanvas.height;
      var d;
      try{ d = sctx.getImageData(0,0,w,h).data; }catch(e){ return 0; }
      var step = Math.max(4, Math.floor(w/90));
      var tot = 0, clr = 0;
      for (var y=0;y<h;y+=step){
        for (var x=0;x<w;x+=step){
          var i = (y*w + x) * 4 + 3;
          tot++;
          if (d[i] === 0) clr++;
        }
      }
      return tot ? Math.round(clr/tot*100) : 0;
    }

    function updateScratch(){
      var p = getScratchPercent();
      scratchProg.textContent = 'åˆ®é–‹é€²åº¦ï¼š' + p + '%ï¼ˆè‡³å°‘ ' + SCRATCH_CONFIRM_THRESHOLD + '% æ‰èƒ½ç¢ºèªï¼‰';
      btnScratchConfirm.disabled = !(p >= SCRATCH_CONFIRM_THRESHOLD);

      if (p > 0 && !hasScratched){
        hasScratched = true;
        btnScratchCancel.disabled = true;
        btnScratchCancel.textContent = 'å·²åˆ®ç„¡æ³•å–æ¶ˆ';
        btnScratchClose.disabled = true;
      }
    }

    function openScratch(n){
      if (revealed[n]) return;
      curNum = n;
      hasScratched = false;
      lastX = null; lastY = null;

      scratchNumber.textContent = String(n);
      scratchOverlay.classList.add('show');
      setScratchCanvasSize();
      scratchMask();

      scratchActive = true;
      btnScratchCancel.disabled = false;
      btnScratchCancel.textContent = 'å–æ¶ˆ';
      btnScratchClose.disabled = false;
      btnScratchConfirm.disabled = true;
      scratchProg.textContent = 'åˆ®é–‹é€²åº¦ï¼š0%ï¼ˆè‡³å°‘ ' + SCRATCH_CONFIRM_THRESHOLD + '% æ‰èƒ½ç¢ºèªï¼‰';
    }

    function closeScratch(){
      scratchOverlay.classList.remove('show');
      scratchActive = false;
      curNum = null;
      hasScratched = false;
    }

    function scratchAt(clientX, clientY){
      var r = scratchCanvas.getBoundingClientRect();
      var x = clientX - r.left;
      var y = clientY - r.top;

      sctx.lineCap = 'round';
      sctx.lineJoin = 'round';
      sctx.lineWidth = Math.max(18, Math.floor(scratchCanvas.width * 0.08));

      sctx.beginPath();
      if (lastX === null){
        sctx.moveTo(x,y);
        sctx.lineTo(x+0.01,y+0.01);
      } else {
        sctx.moveTo(lastX,lastY);
        sctx.lineTo(x,y);
      }
      sctx.stroke();
      lastX = x; lastY = y;
    }

    scratchCanvas.addEventListener('pointerdown', function(e){
      if (!scratchActive) return;
      scratchCanvas.setPointerCapture(e.pointerId);
      lastX = null; lastY = null;
      scratchAt(e.clientX, e.clientY);
      updateScratch();
    });

    scratchCanvas.addEventListener('pointermove', function(e){
      if (!scratchActive) return;
      if ((e.buttons & 1) !== 1) return;
      scratchAt(e.clientX, e.clientY);
      updateScratch();
    });

    btnScratchCancel.addEventListener('click', function(){
      if (hasScratched) return;
      closeScratch();
    });

    btnScratchClose.addEventListener('click', function(){
      if (hasScratched) return;
      closeScratch();
    });

    btnScratchConfirm.addEventListener('click', function(){
      if (curNum == null) return;
      if (getScratchPercent() < SCRATCH_CONFIRM_THRESHOLD) return;
      revealed[curNum] = 1;
      closeScratch();
      build();
    });

    scratchOverlay.addEventListener('click', function(e){
      if (e.target === scratchOverlay && !hasScratched) closeScratch();
    });

    // ===== Build board =====
    function build(){
      board.innerHTML = '';
      if (!order || order.length !== current.total) order = shuffleNums(current.total);

      for (var i=0;i<order.length;i++){
        (function(n){
          var c = document.createElement('div');
          var r = !!revealed[n];
          c.className = 'cell ' + (r ? 'revealed' : 'covered');
          c.textContent = String(n);
          if (r && winning[n]) c.className += ' win';
          c.addEventListener('click', function(){ if (!revealed[n]) openScratch(n); });
          board.appendChild(c);
        })(order[i]);
      }

      renderTitle();
      updateStats();
      fitCellSize();
      save();
    }

    // ===== Fullscreen =====
    function toggleFullscreen(){
      if (!document.fullscreenElement){
        if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
      }
    }
    btnFullscreen.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', fitCellSize);

    // ===== Settings modal =====
    btnSettings.addEventListener('click', function(){
      if (!requirePwd()) return;
      settingsOverlay.classList.add('show');
    });
    btnCloseSettings.addEventListener('click', function(){ settingsOverlay.classList.remove('show'); });
    settingsOverlay.addEventListener('click', function(e){ if (e.target === settingsOverlay) settingsOverlay.classList.remove('show'); });

    // ===== Settings actions =====
    btnRandom.addEventListener('click', function(){
      var raw = prompt('è¦éš¨æ©Ÿé¸å¹¾å€‹ä¸­çè™Ÿç¢¼ï¼Ÿï¼ˆ1â€“' + current.total + 'ï¼‰', '1');
      if (raw === null) return;
      var k = parseInt(raw, 10);
      if (!isFinite(k) || k <= 0) return;

      winning = {};
      var picks = shuffleNums(current.total);
      for (var i=0;i<Math.min(k, picks.length);i++) winning[picks[i]] = 1;
      build();
    });

    btnPick.addEventListener('click', function(){
      var raw = prompt('è¼¸å…¥ä¸­çè™Ÿç¢¼ï¼ˆé€—è™Ÿæˆ–ç©ºç™½åˆ†éš”ï¼‰', '');
      if (raw === null) return;

      winning = {};
      raw = raw.split(',').join(' ');
      raw.split(' ').forEach(function(s){
        s = String(s || '').trim();
        if (!s) return;
        var n = parseInt(s, 10);
        if (isFinite(n) && n>=1 && n<=current.total) winning[n] = 1;
      });

      build();
    });

    btnSize.addEventListener('click', function(){
      var msg = 'é¸æ“‡æ´æ•¸ï¼š\n';
      for (var i=0;i<SIZE_PRESETS.length;i++){
        var s = SIZE_PRESETS[i];
        msg += (i+1) + '. ' + s.total + ' æ´ï¼ˆ' + s.rows + 'Ã—' + s.cols + 'ï¼‰\n';
      }
      msg += '\nè«‹è¼¸å…¥ 1-' + SIZE_PRESETS.length + 'ï¼š';

      var raw = prompt(msg, String(SIZE_PRESETS.length));
      if (raw === null) return;
      var idx = parseInt(raw, 10) - 1;
      if (!isFinite(idx) || !SIZE_PRESETS[idx]) return;

      current = { total: SIZE_PRESETS[idx].total, rows: SIZE_PRESETS[idx].rows, cols: SIZE_PRESETS[idx].cols };
      revealed = {};
      winning = {};
      order = shuffleNums(current.total);
      bumpRound();
      settingsOverlay.classList.remove('show');
      build();
    });

    // âœ… æ›ç‰ˆè¦å¯†ç¢¼ + confirm å­—ä¸²ä¸å¯ç›´æ¥æ›è¡Œ
    btnReset.addEventListener('click', function(){
      if (!requirePwd()) return;
      var ok = confirm('ç¢ºå®šè¦æ›ç‰ˆå—ï¼Ÿ\nï¼ˆæœƒæ¸…ç©ºä¸­çè™Ÿç¢¼èˆ‡æ‰€æœ‰åˆ®é–‹ç‹€æ…‹ï¼‰');
      if (!ok) return;
      revealed = {};
      winning = {};
      order = shuffleNums(current.total);
      bumpRound();
      settingsOverlay.classList.remove('show');
      build();
      // æ›ç‰ˆå®Œæˆå¾Œï¼šé–‹å•Ÿå¯„ä¿¡è‰ç¨¿ï¼ˆæ–¹æ¡ˆAï¼‰
      openMailDraft();
    });

    // ===== Tests =====
    (function(){
      // presets total must match rows*cols
      for (var i=0;i<SIZE_PRESETS.length;i++){
        var p = SIZE_PRESETS[i];
        if (p.total !== p.rows*p.cols) console.warn('TEST FAIL: preset mismatch', p);
      }
      if (SCRATCH_CONFIRM_THRESHOLD !== 10) console.warn('TEST WARN: threshold expected 10');

      // shuffle should return unique length
      var t = shuffleNums(10);
      var seen = {};
      for (var j=0;j<t.length;j++) seen[t[j]] = 1;
      if (Object.keys(seen).length !== 10) console.warn('TEST FAIL: shuffle unique');

      // buildAnswerText join must be a literal "\\n" (no raw newlines in quotes)
      var testLines = ['a','b','c'];
      var joined = testLines.join('\\n');
      if (joined !== 'a\\nb\\nc') console.warn('TEST FAIL: join newline');

      // confirm should include a literal \n escape
      var s = 'ç¢ºå®šè¦æ›ç‰ˆå—ï¼Ÿ\\nï¼ˆæœƒæ¸…ç©ºä¸­çè™Ÿç¢¼èˆ‡æ‰€æœ‰åˆ®é–‹ç‹€æ…‹ï¼‰';
      if (s.indexOf('\\n') === -1) console.warn('TEST FAIL: confirm string escape');

      // mailto should start with mailto:
      var dummyUrl = 'mailto:' + encodeURIComponent('x@y.com') + '?subject=' + encodeURIComponent('t') + '&body=' + encodeURIComponent('b');
      if (dummyUrl.indexOf('mailto:') !== 0) console.warn('TEST FAIL: mailto format');
    })();

    // ===== Init =====
    load();
    if (!order || order.length !== current.total) order = shuffleNums(current.total);
    build();
    window.addEventListener('resize', fitCellSize);
  });
  </script>
</body>
</html>
